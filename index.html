<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Control de Rutas - Versión Multiusuario</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- PASO 2: AÑADIR LOS SCRIPTS DE FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

<style>
:root {
--primary-color: #001F3F;
--secondary-color: #FFFFFF;
--accent-color: #FF6B35;
--success-color: #28a745;
--warning-color: #ffc107;
--danger-color: #dc3545;
--info-color: #17a2b8;
--light-gray: #F8F9FA;
--medium-gray: #E9ECEF;
--dark-gray: #6C757D;
--border-radius: 12px;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
--shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.2);
--shadow-card: 0 10px 30px rgba(0, 31, 63, 0.15);
--shadow-card-hover: 0 20px 40px rgba(0, 31, 63, 0.25);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Poppins', sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
color: #333;
line-height: 1.6;
}

.main-wrapper {
background-color: var(--light-gray);
min-height: 100vh;
}

.header {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: var(--secondary-color);
padding: 1.5rem 0;
box-shadow: var(--shadow);
position: sticky;
top: 0;
z-index: 1000;
}

.header h1 {
font-weight: 600;
margin: 0;
display: flex;
align-items: center;
gap: 12px;
}

.header .subtitle {
font-size: 0.9rem;
opacity: 0.9;
margin-top: 5px;
}

.container-custom {
max-width: 1800px;
margin: 0 auto;
padding: 0 15px;
}

.card-custom {
background-color: var(--secondary-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow);
padding: 1.5rem;
margin-bottom: 2rem;
transition: all 0.3s ease;
border: none;
}

.card-custom:hover {
transform: translateY(-3px);
box-shadow: var(--shadow-hover);
}

.section-title {
color: var(--primary-color);
font-weight: 600;
margin-bottom: 1.5rem;
display: flex;
align-items: center;
gap: 10px;
padding-bottom: 10px;
border-bottom: 2px solid var(--medium-gray);
}

.btn-primary-custom {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: var(--secondary-color);
border: none;
border-radius: var(--border-radius);
padding: 0.7rem 1.5rem;
font-weight: 500;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-primary-custom:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0, 31, 63, 0.3);
}

.btn-secondary-custom {
background-color: var(--medium-gray);
color: var(--primary-color);
border: none;
border-radius: var(--border-radius);
padding: 0.7rem 1.5rem;
font-weight: 500;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-secondary-custom:hover {
background-color: #dee2e6;
transform: translateY(-2px);
}

.btn-danger-custom {
background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
color: var(--secondary-color);
border: none;
border-radius: var(--border-radius);
padding: 0.7rem 1.5rem;
font-weight: 500;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-danger-custom:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(220, 53, 69, 0.3);
}

.btn-success-custom {
background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
color: var(--secondary-color);
border: none;
border-radius: var(--border-radius);
padding: 0.7rem 1.5rem;
font-weight: 500;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-success-custom:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
}

.btn-info-custom {
background: linear-gradient(135deg, var(--info-color) 0%, #138496 100%);
color: var(--secondary-color);
border: none;
border-radius: var(--border-radius);
padding: 0.7rem 1.5rem;
font-weight: 500;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-info-custom:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(23, 162, 184, 0.3);
}

.form-control, .form-select {
border-radius: var(--border-radius);
border: 1px solid #ddd;
padding: 0.75rem;
transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 0.25rem rgba(0, 31, 63, 0.25);
}

.weekly-board {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: var(--secondary-color);
border-radius: var(--border-radius);
padding: 2rem;
margin-bottom: 2rem;
box-shadow: var(--shadow-card);
}

.week-navigation {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
background: rgba(255, 255, 255, 0.95);
color: var(--primary-color);
padding: 1.2rem;
border-radius: var(--border-radius);
flex-wrap: wrap;
gap: 1rem;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(10px);
}

.week-navigation button {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: var(--secondary-color);
border: none;
border-radius: 50%;
width: 50px;
height: 50px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s ease;
font-size: 1.2rem;
box-shadow: 0 4px 10px rgba(0, 31, 63, 0.3);
}

.week-navigation button:hover {
transform: scale(1.1);
box-shadow: 0 6px 15px rgba(0, 31, 63, 0.4);
}

.week-info {
text-align: center;
font-weight: 600;
font-size: 1.2rem;
flex-grow: 1;
color: var(--primary-color);
}

.calendar-picker {
display: flex;
align-items: center;
gap: 10px;
}

.calendar-picker input[type="date"] {
border-radius: var(--border-radius);
border: 2px solid var(--primary-color);
padding: 0.6rem;
font-weight: 500;
background-color: white;
color: var(--primary-color);
cursor: pointer;
box-shadow: 0 2px 8px rgba(0, 31, 63, 0.1);
}

.calendar-picker input[type="date"]::-webkit-calendar-picker-indicator {
cursor: pointer;
filter: invert(0.5);
}

.days-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

/* TARJETAS DE DÍA MEJORADAS */
.day-card {
background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
border-radius: 16px;
padding: 1.5rem;
box-shadow: var(--shadow-card);
transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
position: relative;
border: 2px solid transparent;
display: flex;
flex-direction: column;
min-height: 400px;
overflow: hidden;
}

.day-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
border-radius: 16px 16px 0 0;
}

.day-card:hover {
transform: translateY(-8px) scale(1.02);
box-shadow: var(--shadow-card-hover);
border-color: var(--primary-color);
}

.day-card.today {
background: linear-gradient(145deg, #e8f5e8 0%, #ffffff 100%);
border-color: var(--success-color);
box-shadow: 0 15px 35px rgba(40, 167, 69, 0.25);
}

.day-card.today::before {
background: linear-gradient(90deg, var(--success-color), #20c997);
}

.day-title {
font-weight: 700;
color: var(--primary-color);
margin-bottom: 1rem;
display: flex;
align-items: center;
justify-content: space-between;
padding-bottom: 1rem;
border-bottom: 2px solid var(--medium-gray);
font-size: 1rem;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.day-title i {
color: var(--primary-color);
margin-right: 8px;
}

.day-date {
font-size: 0.75rem;
color: var(--dark-gray);
font-weight: 400;
background: var(--light-gray);
padding: 0.3rem 0.8rem;
border-radius: 20px;
display: inline-block;
}

.day-routes {
flex-grow: 1;
overflow-y: auto;
margin-bottom: 1rem;
padding-right: 0.5rem;
}

.day-routes::-webkit-scrollbar {
width: 4px;
}

.day-routes::-webkit-scrollbar-track {
background: var(--light-gray);
border-radius: 2px;
}

.day-routes::-webkit-scrollbar-thumb {
background: var(--medium-gray);
border-radius: 2px;
}

.day-routes::-webkit-scrollbar-thumb:hover {
background: var(--dark-gray);
}

.route-row {
display: flex;
align-items: center;
background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
border-radius: 12px;
padding: 0.8rem;
margin-bottom: 0.8rem;
transition: all 0.3s ease;
border: 2px solid var(--medium-gray);
position: relative;
cursor: pointer;
box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.route-row:hover {
background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
border-color: var(--primary-color);
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0, 31, 63, 0.15);
}

.route-row.selected {
border-color: var(--success-color);
background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 100%);
box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2);
}

.route-field {
padding: 0.4rem 0.6rem;
font-size: 0.7rem;
border-radius: 8px;
background-color: rgba(255, 255, 255, 0.9);
border: 1px solid rgba(0, 0, 0, 0.08);
transition: all 0.3s ease;
position: relative;
text-align: center;
font-weight: 500;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.route-field.route {
color: var(--primary-color);
flex-grow: 1;
min-width: 70px;
font-weight: 700;
background: linear-gradient(135deg, rgba(0, 31, 63, 0.05) 0%, rgba(0, 31, 63, 0.02) 100%);
}

.route-field.driver {
color: var(--dark-gray);
min-width: 60px;
}

.route-field.truck {
color: var(--success-color);
font-weight: 700;
min-width: 45px;
position: relative;
background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(40, 167, 69, 0.02) 100%);
}

.route-field.truck.needs-refill {
background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
border-color: var(--warning-color);
color: #856404;
animation: pulse 2s infinite;
box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
}

.route-field.truck.selected-record {
background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
border-color: var(--success-color) !important;
color: #155724 !important;
box-shadow: 0 0 15px rgba(40, 167, 69, 0.5) !important;
}

.route-field.truck.other-record {
background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%) !important;
border-color: var(--danger-color) !important;
color: #721c24 !important;
opacity: 0.7;
position: relative;
}

.route-field.truck.other-record::after {
content: "!";
position: absolute;
top: -8px;
right: -8px;
background: var(--danger-color);
color: white;
border-radius: 50%;
width: 20px;
height: 20px;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
}

.selected-indicator {
position: absolute;
top: -8px;
right: -8px;
background: var(--success-color);
color: white;
border-radius: 50%;
width: 20px;
height: 20px;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
}

@keyframes pulse {
0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 193, 7, 0.4); }
50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 193, 7, 0.6); }
100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 193, 7, 0.4); }
}

.route-actions {
display: flex;
gap: 4px;
opacity: 0;
transition: opacity 0.3s ease;
}

.route-row:hover .route-actions {
opacity: 1;
}

.fuel-btn {
background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
color: #000;
border: none;
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s ease;
font-size: 0.7rem;
box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}

.fuel-btn:hover {
transform: scale(1.15);
box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

.delete-btn {
background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
color: white;
border: none;
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s ease;
font-size: 0.7rem;
box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.delete-btn:hover {
transform: scale(1.15);
box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
}

.add-route-btn {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: var(--secondary-color);
border: none;
border-radius: 12px;
padding: 0.8rem;
font-weight: 600;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
font-size: 0.8rem;
width: 100%;
box-shadow: 0 4px 12px rgba(0, 31, 63, 0.3);
}

.add-route-btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0, 31, 63, 0.4);
}

.inline-route-form {
display: flex;
gap: 0.5rem;
margin-bottom: 1rem;
background: linear-gradient(135deg, rgba(0, 31, 63, 0.05) 0%, rgba(0, 31, 63, 0.02) 100%);
padding: 1rem;
border-radius: 12px;
border: 2px dashed var(--primary-color);
box-shadow: inset 0 2px 8px rgba(0, 31, 63, 0.1);
}

.inline-route-form select {
font-size: 0.7rem;
padding: 0.4rem;
border-radius: 8px;
border: 1px solid #ddd;
background: white;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.inline-route-form button {
font-size: 0.7rem;
padding: 0.4rem 0.6rem;
border-radius: 8px;
}

/* Badge mejorado */
.badge-custom {
padding: 0.5rem 1rem;
border-radius: 20px;
font-weight: 600;
font-size: 0.8rem;
box-shadow: 0 2px 8px rgba(0, 31, 63, 0.2);
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
}

/* Estado vacío mejorado */
.empty-state {
text-align: center;
padding: 2rem 1rem;
color: var(--dark-gray);
background: linear-gradient(135deg, var(--light-gray) 0%, white 100%);
border-radius: 12px;
border: 2px dashed var(--medium-gray);
margin: 1rem 0;
}

.empty-state i {
font-size: 2.5rem;
margin-bottom: 1rem;
opacity: 0.6;
color: var(--primary-color);
}

.empty-state p {
margin-bottom: 0;
font-size: 0.85rem;
font-weight: 500;
}

.refill-section {
background: linear-gradient(135deg, var(--info-color) 0%, #138496 100%);
color: white;
border-radius: var(--border-radius);
padding: 2rem;
margin-bottom: 2rem;
box-shadow: var(--shadow-card);
}

.refill-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
flex-wrap: wrap;
gap: 1rem;
}

.refill-title {
font-size: 1.3rem;
font-weight: 600;
display: flex;
align-items: center;
gap: 12px;
}

.refill-toggle {
background: rgba(255, 255, 255, 0.2);
border: 1px solid rgba(255, 255, 255, 0.3);
color: white;
padding: 0.6rem 1.2rem;
border-radius: 25px;
cursor: pointer;
transition: all 0.3s ease;
font-size: 0.9rem;
font-weight: 500;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.refill-toggle:hover {
background: rgba(255, 255, 255, 0.3);
transform: translateY(-1px);
}

.refill-toggle.active {
background: var(--success-color);
border-color: var(--success-color);
box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.refill-list {
background-color: white;
border-radius: var(--border-radius);
padding: 1.5rem;
margin-top: 1.5rem;
color: black;
font-family: 'Courier New', monospace;
font-size: 16px;
white-space: pre-wrap;
line-height: 1.8;
max-height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
}

.refill-text-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
font-family: 'Poppins', sans-serif;
font-size: 1.1rem;
color: var(--primary-color);
font-weight: 600;
}

.copy-btn {
background: var(--primary-color);
color: white;
border: none;
border-radius: 8px;
padding: 0.5rem 1rem;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s ease;
box-shadow: 0 2px 8px rgba(0, 31, 63, 0.3);
}

.copy-btn:hover {
background: #003d7a;
transform: translateY(-1px);
}

.toast-container {
position: fixed;
top: 80px;
right: 20px;
z-index: 1050;
}

.toast-custom {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: var(--secondary-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-hover);
padding: 1rem 1.5rem;
margin-bottom: 0.5rem;
display: flex;
align-items: center;
gap: 12px;
animation: slideIn 0.3s ease;
min-width: 280px;
backdrop-filter: blur(10px);
}

@keyframes slideIn {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

.search-box {
position: relative;
margin-bottom: 1.5rem;
}

.search-box input {
padding-left: 45px;
}

.search-box i {
position: absolute;
left: 15px;
top: 50%;
transform: translateY(-50%);
color: var(--dark-gray);
}

.excel-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 1rem;
font-size: 0.9rem;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
border-radius: var(--border-radius);
overflow: hidden;
}

.excel-table thead {
background-color: var(--primary-color);
color: white;
}

.excel-table th {
padding: 0.75rem;
text-align: left;
font-weight: 600;
position: sticky;
top: 0;
z-index: 10;
cursor: pointer;
transition: all 0.3s ease;
}

.excel-table th:hover {
background-color: #003d7a;
}

.excel-table th .filter-icon {
float: right;
opacity: 0.7;
transition: all 0.3s ease;
}

.excel-table th:hover .filter-icon {
opacity: 1;
}

.excel-table th.filtered {
background-color: #003d7a;
}

.excel-table th.filtered .filter-icon {
opacity: 1;
color: var(--warning-color);
}

.excel-table tbody tr:nth-child(even) {
background-color: var(--light-gray);
}

.excel-table tbody tr:hover {
background-color: var(--medium-gray);
}

.excel-table td {
padding: 0.6rem 0.75rem;
border-bottom: 1px solid var(--medium-gray);
}

.excel-table .actions-cell {
width: 100px;
text-align: center;
}

.excel-table .btn-sm {
padding: 0.25rem 0.5rem;
font-size: 0.75rem;
margin: 0 2px;
}

.table-container {
max-height: 500px;
overflow-y: auto;
border-radius: var(--border-radius);
border: 1px solid var(--medium-gray);
}

.table-container::-webkit-scrollbar {
width: 8px;
}

.table-container::-webkit-scrollbar-track {
background: var(--light-gray);
border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb {
background: var(--medium-gray);
border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb:hover {
background: var(--dark-gray);
}

.nav-tabs {
border-bottom: 2px solid var(--primary-color);
margin-bottom: 2rem;
}

.nav-tabs .nav-link {
color: var(--primary-color);
font-weight: 500;
border: none;
border-bottom: 3px solid transparent;
border-radius: 0;
padding: 0.8rem 1.5rem;
transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
border-bottom-color: var(--primary-color);
background-color: transparent;
}

.nav-tabs .nav-link.active {
color: var(--primary-color);
background-color: transparent;
border-bottom-color: var(--primary-color);
font-weight: 600;
}

.tab-content {
margin-top: 1rem;
}

/* Estilos para Listas Mejoradas */
.list-container {
max-height: 600px;
overflow-y: auto;
border-radius: var(--border-radius);
border: 1px solid var(--medium-gray);
background: white;
}

.list-container::-webkit-scrollbar {
width: 8px;
}

.list-container::-webkit-scrollbar-track {
background: var(--light-gray);
border-radius: 4px;
}

.list-container::-webkit-scrollbar-thumb {
background: var(--medium-gray);
border-radius: 4px;
}

.list-container::-webkit-scrollbar-thumb:hover {
background: var(--dark-gray);
}

.list-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 2px solid var(--medium-gray);
background: linear-gradient(135deg, var(--light-gray) 0%, white 100%);
padding: 1rem;
border-radius: var(--border-radius) var(--border-radius) 0 0;
margin: -1.5rem -1.5rem 1.5rem -1.5rem;
}

.list-title {
font-size: 1.3rem;
font-weight: 600;
color: var(--primary-color);
display: flex;
align-items: center;
gap: 10px;
}

.list-stats {
display: flex;
gap: 1rem;
align-items: center;
}

.stat-badge {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: white;
padding: 0.4rem 1rem;
border-radius: 20px;
font-size: 0.85rem;
font-weight: 500;
box-shadow: 0 2px 8px rgba(0, 31, 63, 0.2);
}

.list-content {
min-height: 200px;
padding: 0 1rem 1rem;
}

.list-item {
background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
border-radius: 12px;
padding: 1.2rem;
margin-bottom: 1rem;
display: flex;
justify-content: space-between;
align-items: center;
transition: all 0.3s ease;
border-left: 4px solid var(--accent-color);
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
position: relative;
overflow: hidden;
}

.list-item::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 2px;
background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
opacity: 0;
transition: opacity 0.3s ease;
}

.list-item:hover {
transform: translateX(5px);
box-shadow: 0 4px 15px rgba(0,0,0,0.15);
border-left-color: var(--primary-color);
}

.list-item:hover::before {
opacity: 1;
}

.list-item-content {
flex-grow: 1;
}

.list-item-title {
font-weight: 600;
color: var(--primary-color);
font-size: 1.1rem;
margin-bottom: 0.3rem;
}

.list-item-subtitle {
color: var(--dark-gray);
font-size: 0.9rem;
}

.list-item-actions {
display: flex;
gap: 8px;
}

.list-item-actions button {
padding: 0.4rem 0.8rem;
font-size: 0.85rem;
border-radius: 8px;
transition: all 0.3s ease;
}

.list-item-actions button:hover {
transform: translateY(-2px);
}

.danger-zone {
background-color: #fff5f5;
border: 2px solid #fed7d7;
border-radius: var(--border-radius);
padding: 1.5rem;
margin-top: 2rem;
}

.danger-zone-title {
color: var(--danger-color);
font-weight: 600;
margin-bottom: 1rem;
display: flex;
align-items: center;
gap: 10px;
}

.stats-card {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: white;
border-radius: var(--border-radius);
padding: 1.5rem;
text-align: center;
transition: all 0.3s ease;
height: 100%;
box-shadow: var(--shadow-card);
}

.stats-card:hover {
transform: translateY(-5px);
box-shadow: var(--shadow-card-hover);
}

.stats-number {
font-size: 2.5rem;
font-weight: 700;
margin-bottom: 0.5rem;
}

.stats-label {
font-size: 0.9rem;
opacity: 0.9;
}

.modal-content {
border-radius: var(--border-radius);
border: none;
}

.modal-header {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: white;
border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.modal-header .btn-close {
filter: brightness(0) invert(1);
}

.badge-custom {
padding: 0.5rem 0.75rem;
border-radius: 20px;
font-weight: 500;
}

.pagination-container {
display: flex;
justify-content: center;
margin-top: 2rem;
}

.pagination .page-link {
color: var(--primary-color);
border-color: var(--medium-gray);
margin: 0 2px;
border-radius: var(--border-radius);
}

.pagination .page-item.active .page-link {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
border-color: var(--primary-color);
}

.chart-container {
position: relative;
height: 300px;
margin-bottom: 2rem;
}

.report-filters {
background-color: var(--light-gray);
border-radius: var(--border-radius);
padding: 1rem;
margin-bottom: 2rem;
}

.validation-error {
border-color: var(--danger-color) !important;
box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
}

.validation-message {
color: var(--danger-color);
font-size: 0.875rem;
margin-top: 0.25rem;
}

.btn-sm {
padding: 0.25rem 0.5rem;
font-size: 0.875rem;
}

.btn-outline-primary {
color: var(--primary-color);
border-color: var(--primary-color);
}

.btn-outline-primary:hover {
background-color: var(--primary-color);
color: white;
}

.btn-outline-danger {
color: var(--danger-color);
border-color: var(--danger-color);
}

.btn-outline-danger:hover {
background-color: var(--danger-color);
color: white;
}

.connection-indicator {
position: fixed;
top: 20px;
left: 20px;
z-index: 1001;
display: flex;
align-items: center;
gap: 8px;
padding: 8px 12px;
border-radius: 20px;
font-size: 0.85rem;
font-weight: 500;
transition: all 0.3s ease;
}

.connection-indicator.online {
background-color: var(--success-color);
color: white;
}

.connection-indicator.offline {
background-color: var(--warning-color);
color: #000;
}

.connection-indicator i {
animation: pulse 2s infinite;
}

.undo-redo-container {
position: fixed;
bottom: 20px;
right: 20px;
z-index: 1000;
display: flex;
gap: 10px;
}

.undo-redo-btn {
width: 50px;
height: 50px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
background: var(--primary-color);
color: white;
border: none;
box-shadow: var(--shadow);
transition: all 0.3s ease;
cursor: pointer;
}

.undo-redo-btn:hover:not(:disabled) {
transform: scale(1.1);
box-shadow: var(--shadow-hover);
}

.undo-redo-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Vista de Calendario MEJORADA */
.calendar-view {
background: white;
border-radius: var(--border-radius);
padding: 1.5rem;
margin-bottom: 2rem;
box-shadow: var(--shadow);
}

.calendar-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
flex-wrap: wrap;
gap: 1rem;
}

.calendar-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--primary-color);
display: flex;
align-items: center;
gap: 10px;
}

.calendar-nav {
display: flex;
gap: 1rem;
align-items: center;
}

.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 1px;
background-color: var(--medium-gray);
border: 1px solid var(--medium-gray);
border-radius: var(--border-radius);
overflow: hidden;
}

.calendar-day-header {
background-color: var(--primary-color);
color: white;
padding: 1rem;
text-align: center;
font-weight: 600;
font-size: 0.9rem;
}

.calendar-day {
background-color: white;
min-height: 180px;
max-height: 300px;
padding: 0.5rem;
position: relative;
cursor: pointer;
transition: all 0.3s ease;
overflow: hidden;
display: flex;
flex-direction: column;
}

.calendar-day:hover {
background-color: var(--light-gray);
transform: scale(1.02);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
z-index: 10;
}

.calendar-day.other-month {
background-color: #f8f9fa;
color: var(--dark-gray);
opacity: 0.6;
}

.calendar-day.today {
background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 100%);
border: 2px solid var(--success-color);
box-shadow: 0 0 20px rgba(40, 167, 69, 0.2);
}

/* Resaltado para día seleccionado */
.calendar-day.selected-highlight {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
  border: 3px solid var(--warning-color) !important;
  box-shadow: 0 0 25px rgba(255, 193, 7, 0.5) !important;
  transform: scale(1.05) !important;
  z-index: 20 !important;
}

.calendar-day.selected-highlight .calendar-day-number {
  color: var(--warning-color) !important;
  font-weight: 800 !important;
}

.calendar-day.selected-highlight .calendar-route-item {
  background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%) !important;
  color: #000 !important;
}

.calendar-day-number {
font-weight: 700;
font-size: 1.1rem;
margin-bottom: 0.5rem;
color: var(--primary-color);
display: flex;
justify-content: space-between;
align-items: center;
}

.calendar-day-routes {
flex-grow: 1;
overflow-y: auto;
overflow-x: hidden;
padding-right: 0.25rem;
}

/* Scrollbar personalizado para rutas del calendario */
.calendar-day-routes::-webkit-scrollbar {
width: 4px;
}

.calendar-day-routes::-webkit-scrollbar-track {
background: #f1f1f1;
border-radius: 2px;
}

.calendar-day-routes::-webkit-scrollbar-thumb {
background: #888;
border-radius: 2px;
}

.calendar-day-routes::-webkit-scrollbar-thumb:hover {
background: #555;
}

.calendar-route-item {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: white;
padding: 0.3rem 0.5rem;
border-radius: 6px;
margin-bottom: 0.3rem;
font-size: 0.55rem;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
cursor: pointer;
transition: all 0.3s ease;
position: relative;
font-weight: 500;
}

.calendar-route-item:hover {
background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
transform: translateX(2px);
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.calendar-route-item.marked {
background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
color: #000;
font-weight: 600;
}

.calendar-route-item.marked::after {
content: '⛽';
position: absolute;
right: 4px;
top: 50%;
transform: translateY(-50%);
font-size: 0.8rem;
}

.calendar-day-stats {
position: absolute;
top: 0.5rem;
right: 0.5rem;
display: flex;
flex-direction: column;
align-items: flex-end;
gap: 0.2rem;
}

.route-count-badge {
background: var(--primary-color);
color: white;
border-radius: 10px;
padding: 0.2rem 0.5rem;
font-size: 0.65rem;
font-weight: 600;
min-width: 20px;
text-align: center;
}

.marked-count-badge {
background: var(--warning-color);
color: #000;
border-radius: 10px;
padding: 0.2rem 0.5rem;
font-size: 0.65rem;
font-weight: 600;
min-width: 20px;
text-align: center;
}

/* Vista de lista de día */
.day-list-modal .modal-dialog {
max-width: 800px;
}

.day-list-header {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: white;
padding: 1.5rem;
border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.day-list-title {
font-size: 1.3rem;
font-weight: 600;
margin-bottom: 0.5rem;
}

.day-list-date {
font-size: 0.9rem;
opacity: 0.9;
}

.day-list-content {
padding: 1.5rem;
}

.day-list-route {
background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
border-radius: 12px;
padding: 1rem;
margin-bottom: 1rem;
border-left: 4px solid var(--primary-color);
transition: all 0.3s ease;
}

.day-list-route:hover {
transform: translateX(5px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.day-list-route.marked {
border-left-color: var(--warning-color);
background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
}

.day-list-route-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.day-list-route-title {
font-weight: 600;
color: var(--primary-color);
font-size: 1.1rem;
}

.day-list-route-details {
display: flex;
gap: 1rem;
font-size: 0.9rem;
color: var(--dark-gray);
}

.day-list-route-detail {
display: flex;
align-items: center;
gap: 0.3rem;
}

.day-list-route-detail i {
color: var(--primary-color);
}

/* Vista de mes compacta */
.calendar-compact-view {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 1px;
background-color: var(--medium-gray);
border: 1px solid var(--medium-gray);
border-radius: var(--border-radius);
overflow: hidden;
margin-bottom: 1rem;
}

.calendar-compact-day {
background-color: white;
padding: 0.5rem;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
min-height: 60px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.calendar-compact-day:hover {
background-color: var(--light-gray);
}

.calendar-compact-day.today {
background-color: #e8f5e8;
border: 1px solid var(--success-color);
}

.calendar-compact-day.has-routes {
background: linear-gradient(135deg, #f0f8ff 0%, #ffffff 100%);
}

.calendar-compact-day-number {
font-weight: 600;
font-size: 0.9rem;
}

.calendar-compact-day-routes {
font-size: 0.6rem;
color: var(--primary-color);
margin-top: 0.2rem;
}

/* Vista de lista de mes */
.calendar-list-view {
background: white;
border-radius: var(--border-radius);
padding: 1.5rem;
}

.calendar-list-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 2px solid var(--medium-gray);
}

.calendar-list-title {
font-size: 1.3rem;
font-weight: 600;
color: var(--primary-color);
}

.calendar-list-content {
max-height: 500px;
overflow-y: auto;
}

.calendar-list-day {
margin-bottom: 1.5rem;
padding: 1rem;
background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
border-radius: 12px;
border-left: 4px solid var(--primary-color);
}

.calendar-list-day-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
}

.calendar-list-day-title {
font-weight: 600;
color: var(--primary-color);
font-size: 1.1rem;
}

.calendar-list-day-routes {
display: flex;
flex-direction: column;
gap: 0.5rem;
}

.calendar-list-route {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.5rem;
background: white;
border-radius: 8px;
border: 1px solid var(--medium-gray);
}

.calendar-list-route-info {
display: flex;
gap: 1rem;
align-items: center;
}

.calendar-list-route-full {
font-weight: 600;
color: var(--primary-color);
font-size: 0.9rem;
}

.calendar-list-route-truck {
font-weight: 600;
color: var(--success-color);
}

.calendar-list-route-name {
color: var(--primary-color);
}

.calendar-list-route-driver {
color: var(--dark-gray);
font-size: 0.9rem;
}

.calendar-list-route-actions {
display: flex;
gap: 0.5rem;
}

/* Vista de Semana Compacta MEJORADA SIN SCROLL */
.calendar-week-view {
  background: white;
  border-radius: var(--border-radius);
  padding: 1rem;
  overflow-x: auto;
}

.calendar-week-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--medium-gray);
}

.calendar-week-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Grid compacto de semana SIN SCROLL */
.calendar-week-grid-compact {
  display: grid;
  grid-template-columns: 80px repeat(7, 1fr);
  gap: 1px;
  background-color: var(--medium-gray);
  border: 1px solid var(--medium-gray);
  border-radius: var(--border-radius);
  overflow: hidden;
  min-height: 500px;
}

/* Encabezado de la fila de tiempo */
.calendar-week-time-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
  color: white;
  padding: 0.8rem 0.5rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Encabezados de días de la semana */
.calendar-week-day-header-compact {
  background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
  color: white;
  padding: 0.8rem 0.5rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.8rem;
  border-left: 1px solid rgba(255,255,255,0.1);
  position: relative;
}

.calendar-week-day-header-compact.today {
  background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
}

.calendar-week-day-header-compact .day-name {
  display: block;
  font-size: 0.7rem;
  opacity: 0.9;
  margin-bottom: 0.2rem;
}

.calendar-week-day-header-compact .day-number {
  display: block;
  font-size: 1rem;
  font-weight: 700;
}

.calendar-week-day-header-compact .route-count {
  position: absolute;
  top: 0.3rem;
  right: 0.3rem;
  background: rgba(255,255,255,0.2);
  color: white;
  border-radius: 10px;
  padding: 0.1rem 0.4rem;
  font-size: 0.6rem;
  font-weight: 600;
}

/* Contenedor de rutas por día SIN SCROLL */
.calendar-week-day-content-compact {
  background: white;
  min-height: 450px;
  padding: 0.3rem;
  border-left: 1px solid var(--medium-gray);
  position: relative;
  display: flex;
  flex-direction: column;
}

.calendar-week-day-content-compact.today {
  background: linear-gradient(135deg, #e8f5e8 0%, #ffffff 100%);
}

.calendar-week-day-content-compact:hover {
  background: linear-gradient(135deg, #f0f8ff 0%, #ffffff 100%);
}

/* Lista de rutas compacta SIN SCROLL */
.calendar-week-routes-list {
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
  flex-grow: 1;
  overflow: hidden;
}

/* Ruta individual ultra compacta */
.calendar-week-route-compact {
  background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
  border: 1px solid #e9ecef;
  border-radius: 4px;
  padding: 0.25rem 0.3rem;
  font-size: 0.6rem;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 20px;
  line-height: 1.2;
}

.calendar-week-route-compact:hover {
  background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
  border-color: var(--primary-color);
  transform: translateX(2px);
  box-shadow: 0 2px 6px rgba(0, 31, 63, 0.1);
  z-index: 10;
}

.calendar-week-route-compact.marked {
  background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
  border-color: var(--warning-color);
}

.calendar-week-route-compact.marked::before {
  content: '⛽';
  position: absolute;
  left: 2px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.6rem;
  color: var(--warning-color);
}

.calendar-week-route-text {
  font-weight: 600;
  color: var(--primary-color);
  flex-grow: 1;
  margin-left: 0.8rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.55rem;
}

.calendar-week-route-actions-compact {
  display: flex;
  gap: 1px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.calendar-week-route-compact:hover .calendar-week-route-actions-compact {
  opacity: 1;
}

.calendar-week-route-btn-compact {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 2px;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.4rem;
}

.calendar-week-route-btn-compact:hover {
  transform: scale(1.1);
}

.calendar-week-route-btn-compact.fuel {
  background: var(--warning-color);
  color: #000;
}

.calendar-week-route-btn-compact.delete {
  background: var(--danger-color);
}

/* Estado vacío compacto */
.calendar-week-empty-compact {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  min-height: 200px;
  color: var(--dark-gray);
  font-size: 0.65rem;
  text-align: center;
  padding: 0.5rem;
}

.calendar-week-empty-compact i {
  font-size: 1.2rem;
  margin-bottom: 0.3rem;
  opacity: 0.5;
}

/* Indicadores de día */
.calendar-week-day-indicators {
  position: absolute;
  top: 0.3rem;
  right: 0.3rem;
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
  align-items: flex-end;
}

.calendar-week-indicator {
  background: var(--primary-color);
  color: white;
  border-radius: 6px;
  padding: 0.1rem 0.2rem;
  font-size: 0.5rem;
  font-weight: 600;
  min-width: 14px;
  text-align: center;
}

.calendar-week-indicator.marked {
  background: var(--warning-color);
  color: #000;
}

/* Responsive para vista compacta */
@media (max-width: 1200px) {
  .calendar-week-grid-compact {
    grid-template-columns: 60px repeat(7, 1fr);
  }
  
  .calendar-week-route-text {
    font-size: 0.5rem;
  }
}

@media (max-width: 768px) {
  .calendar-week-grid-compact {
    grid-template-columns: 50px repeat(7, 1fr);
    font-size: 0.7rem;
  }
  
  .calendar-week-day-header-compact {
    padding: 0.5rem 0.3rem;
    font-size: 0.7rem;
  }
  
  .calendar-week-route-compact {
    font-size: 0.55rem;
    padding: 0.2rem 0.3rem;
    min-height: 18px;
  }
  
  .calendar-week-route-btn-compact {
    width: 14px;
    height: 14px;
    font-size: 0.35rem;
  }
  
  .calendar-week-route-text {
    font-size: 0.45rem;
  }
}

/* Vista de Día */
.calendar-day-view {
background: white;
border-radius: var(--border-radius);
padding: 1.5rem;
}

.calendar-day-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 2px solid var(--medium-gray);
}

.calendar-day-title {
font-size: 1.5rem;
font-weight: 600;
color: var(--primary-color);
display: flex;
align-items: center;
gap: 10px;
}

.calendar-day-info {
display: flex;
gap: 1rem;
align-items: center;
}

.calendar-day-date {
font-size: 1.1rem;
color: var(--dark-gray);
font-weight: 500;
}

.calendar-day-stats {
display: flex;
gap: 1rem;
}

.calendar-day-stat {
background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
color: white;
padding: 0.5rem 1rem;
border-radius: 20px;
font-size: 0.9rem;
font-weight: 500;
display: flex;
align-items: center;
gap: 0.5rem;
}

.calendar-day-stat.marked {
background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
color: #000;
}

.calendar-day-content {
display: grid;
grid-template-columns: 1fr;
gap: 1.5rem;
}

.calendar-day-routes-list {
background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
border-radius: 16px;
padding: 2rem;
box-shadow: var(--shadow-card);
}

.calendar-day-routes-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 2px solid var(--medium-gray);
}

.calendar-day-routes-title {
font-size: 1.2rem;
font-weight: 600;
color: var(--primary-color);
display: flex;
align-items: center;
gap: 10px;
}

.calendar-day-route-card {
background: white;
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 1rem;
border-left: 4px solid var(--primary-color);
transition: all 0.3s ease;
box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.calendar-day-route-card:hover {
transform: translateX(5px);
box-shadow: 0 4px 15px rgba(0,0,0,0.15);
border-left-color: var(--accent-color);
}

.calendar-day-route-card.marked {
border-left-color: var(--warning-color);
background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
}

.calendar-day-route-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
}

.calendar-day-route-title {
font-size: 1.1rem;
font-weight: 600;
color: var(--primary-color);
}

.calendar-day-route-details {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
margin-bottom: 1rem;
}

.calendar-day-route-detail {
display: flex;
align-items: center;
gap: 0.5rem;
}

.calendar-day-route-detail i {
color: var(--primary-color);
font-size: 1rem;
}

.calendar-day-route-detail-label {
font-weight: 500;
color: var(--dark-gray);
}

.calendar-day-route-detail-value {
font-weight: 600;
color: var(--primary-color);
}

.calendar-day-route-actions {
display: flex;
gap: 0.5rem;
justify-content: flex-end;
}

/* Sistema de Filtros Simple */
.filter-section {
background-color: var(--light-gray);
border-radius: var(--border-radius);
padding: 1.5rem;
margin-bottom: 2rem;
}

.filter-row {
display: flex;
gap: 1rem;
margin-bottom: 1rem;
flex-wrap: wrap;
}

.filter-group {
flex: 1;
min-width: 200px;
}

.filter-group label {
display: block;
margin-bottom: 0.5rem;
font-weight: 500;
color: var(--primary-color);
}

.filter-actions {
display: flex;
gap: 0.5rem;
justify-content: flex-end;
}

.active-filters {
display: flex;
flex-wrap: wrap;
gap: 0.5rem;
margin-top: 1rem;
}

.filter-tag {
display: inline-flex;
align-items: center;
background-color: var(--primary-color);
color: white;
border-radius: 20px;
padding: 0.3rem 0.8rem;
font-size: 0.8rem;
font-weight: 500;
transition: all 0.2s ease;
}

.filter-tag:hover {
background-color: #003d7a;
transform: translateY(-1px);
}

.filter-tag i {
margin-left: 0.5rem;
cursor: pointer;
opacity: 0.8;
transition: opacity 0.2s ease;
}

.filter-tag i:hover {
opacity: 1;
}

/* Botones de vista de calendario */
.calendar-view-buttons {
display: flex;
gap: 0.5rem;
flex-wrap: wrap;
}

.calendar-view-btn {
padding: 0.5rem 1rem;
border: 1px solid var(--primary-color);
background: white;
color: var(--primary-color);
border-radius: 8px;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 0.5rem;
}

.calendar-view-btn:hover {
background: var(--primary-color);
color: white;
}

.calendar-view-btn.active {
background: var(--primary-color);
color: white;
}

/* Responsive */
@media (max-width: 768px) {
.days-grid {
grid-template-columns: 1fr;
gap: 1rem;
}

.day-card {
min-height: 350px;
}

.week-navigation {
flex-direction: column;
gap: 1rem;
}

.header h1 {
font-size: 1.5rem;
}

.chart-container {
height: 250px;
}

.route-field {
font-size: 0.6rem;
min-width: 40px;
}

.excel-table {
font-size: 0.8rem;
}

.excel-table th, .excel-table td {
padding: 0.5rem;
}

.connection-indicator {
top: 10px;
left: 10px;
font-size: 0.75rem;
}

.undo-redo-container {
bottom: 10px;
right: 10px;
}

.undo-redo-btn {
width: 40px;
height: 40px;
}

.filter-row {
flex-direction: column;
}

.calendar-grid {
grid-template-columns: repeat(7, 1fr);
gap: 0;
}

.calendar-day {
min-height: 120px;
padding: 0.3rem;
}

.calendar-route-item {
font-size: 0.45rem;
}

.calendar-header {
flex-direction: column;
align-items: stretch;
}

.calendar-nav {
justify-content: center;
}

.calendar-week-grid {
grid-template-columns: 1fr;
gap: 1rem;
}

.calendar-day-content {
grid-template-columns: 1fr;
}

.list-header {
flex-direction: column;
gap: 1rem;
align-items: flex-start;
}

.list-stats {
width: 100%;
justify-content: space-between;
}
}

@media (max-width: 576px) {
.day-card {
min-height: 300px;
padding: 1rem;
}

.route-field {
font-size: 0.6rem;
padding: 0.3rem;
}

.fuel-btn, .delete-btn {
width: 24px;
height: 24px;
font-size: 0.6rem;
}

.excel-table {
font-size: 0.7rem;
}

.excel-table th, .excel-table td {
padding: 0.4rem;
}

.excel-table .actions-cell {
width: 80px;
}

.calendar-day {
min-height: 100px;
padding: 0.2rem;
}

.calendar-route-item {
font-size: 0.4rem;
padding: 0.2rem 0.3rem;
}

.calendar-day-number {
font-size: 0.9rem;
}

.calendar-view-buttons {
flex-wrap: wrap;
}

.calendar-week-day {
min-height: 250px;
padding: 1rem;
}

.calendar-day-route-card {
padding: 1rem;
}

.calendar-day-route-details {
grid-template-columns: 1fr;
gap: 0.5rem;
}
}

/* === Selector de Fecha Compacto === */
.date-selector-container {
  background: linear-gradient(135deg, var(--primary-color) 0%, #003d7a 100%);
  color: white;
  border-radius: var(--border-radius);
  padding: 1rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-card);
  max-width: 280px;
}
.date-input-custom {
  border-radius: var(--border-radius);
  border: none;
  padding: 0.5rem 0.75rem;
  font-family: 'Poppins', sans-serif;
  font-size: 0.9rem;
  color: #333;
}
.date-input-custom:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
}
.day-card {
  max-height: 400px !important;
  overflow-y: auto !important;
  scrollbar-width: thin;
  scrollbar-color: var(--medium-gray) var(--light-gray);
}
.day-card::-webkit-scrollbar {
  width: 6px;
}
.day-card::-webkit-scrollbar-track {
  background: var(--light-gray);
  border-radius: 3px;
}
.day-card::-webkit-scrollbar-thumb {
  background: var(--medium-gray);
  border-radius: 3px;
}
.day-card::-webkit-scrollbar-thumb:hover {
  background: var(--dark-gray);
}
    </style>
    
</head>
<body>
<!-- Indicador de Conexión -->
<div class="connection-indicator online" id="connectionIndicator">
<i class="fas fa-wifi"></i>
<span>Online</span>
</div>

<!-- Botones de Undo/Redo -->
<div class="undo-redo-container">
<button class="undo-redo-btn" id="undoBtn" disabled title="Deshacer">
<i class="fas fa-undo"></i>
</button>
<button class="undo-redo-btn" id="redoBtn" disabled title="Rehacer">
<i class="fas fa-redo"></i>
</button>
</div>

<div class="main-wrapper">
<!-- Header -->
<header class="header">
<div class="container-custom">
<h1>
<i class="fas fa-truck"></i> Sistema de Control de Rutas
<span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
</h1>
<div class="subtitle">Gestión eficiente de transporte y logística v6.0 - Multiusuario</div>
</div>
</header>

<!-- Main Content -->
<main class="container-custom py-4">
<!-- Navigation Tabs -->
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
<i class="fas fa-tachometer-alt"></i> Dashboard
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="routes-tab" data-bs-toggle="tab" data-bs-target="#routes" type="button" role="tab">
<i class="fas fa-route"></i> Rutas
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="drivers-tab" data-bs-toggle="tab" data-bs-target="#drivers" type="button" role="tab">
<i class="fas fa-user-tie"></i> Choferes
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="trucks-tab" data-bs-toggle="tab" data-bs-target="#trucks" type="button" role="tab">
<i class="fas fa-truck-pickup"></i> Unidades
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
<i class="fas fa-history"></i> Historial
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab">
<i class="fas fa-calendar-alt"></i> Calendario
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
<i class="fas fa-chart-bar"></i> Reportes
</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="mainTabContent">
<!-- Dashboard Tab -->
<div class="tab-pane fade show active" id="dashboard" role="tabpanel">
<!-- Statistics Cards -->
<div class="row mb-4">
<div class="col-md-3 col-sm-6 mb-3">
<div class="stats-card">
<div class="stats-number" id="totalRoutes">0</div>
<div class="stats-label">Rutas Totales</div>
</div>
</div>
<div class="col-md-3 col-sm-6 mb-3">
<div class="stats-card">
<div class="stats-number" id="activeTrucks">0</div>
<div class="stats-label">Unidades Activas</div>
</div>
</div>
<div class="col-md-3 col-sm-6 mb-3">
<div class="stats-card">
<div class="stats-number" id="totalDrivers">0</div>
<div class="stats-label">Choferes</div>
</div>
</div>
<div class="col-md-3 col-sm-6 mb-3">
<div class="stats-card">
<div class="stats-number" id="weekRoutes">0</div>
<div class="stats-label">Rutas Semana</div>
</div>
</div>
</div>

<!-- Weekly Board -->
<section class="weekly-board">
<div class="week-navigation">
<button id="prevWeekBtn">
<i class="fas fa-chevron-left"></i>
</button>
<div class="week-info">
<div id="weekRange">Semana del</div>
</div>
<button id="nextWeekBtn">
<i class="fas fa-chevron-right"></i>
</button>
<div class="calendar-picker">
<label for="calendarPicker" class="form-label mb-0 me-2">
<i class="fas fa-calendar-alt"></i> Ir a fecha:
</label>
<input type="date" id="calendarPicker" class="form-control">
</div>
</div>
<h2 class="mb-3">
<i class="fas fa-calendar-week"></i> Tablero Semanal
</h2>
<div class="days-grid">
<div class="day-card" data-day="LUNES">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> LUNES</span>
<div class="day-date" id="date-LUNES"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-LUNES">0</span>
</div>

<div class="day-routes" id="routes-LUNES" data-day="LUNES">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('LUNES')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>

<div class="day-card" data-day="MARTES">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> MARTES</span>
<div class="day-date" id="date-MARTES"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-MARTES">0</span>
</div>

<div class="day-routes" id="routes-MARTES" data-day="MARTES">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('MARTES')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>

<div class="day-card" data-day="MIÉRCOLES">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> MIÉRCOLES</span>
<div class="day-date" id="date-MIÉRCOLES"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-MIÉRCOLES">0</span>
</div>

<div class="day-routes" id="routes-MIÉRCOLES" data-day="MIÉRCOLES">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('MIÉRCOLES')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>

<div class="day-card" data-day="JUEVES">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> JUEVES</span>
<div class="day-date" id="date-JUEVES"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-JUEVES">0</span>
</div>

<div class="day-routes" id="routes-JUEVES" data-day="JUEVES">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('JUEVES')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>

<div class="day-card" data-day="VIERNES">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> VIERNES</span>
<div class="day-date" id="date-VIERNES"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-VIERNES">0</span>
</div>

<div class="day-routes" id="routes-VIERNES" data-day="VIERNES">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('VIERNES')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>

<div class="day-card" data-day="SÁBADO">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> SÁBADO</span>
<div class="day-date" id="date-SÁBADO"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-SÁBADO">0</span>
</div>

<div class="day-routes" id="routes-SÁBADO" data-day="SÁBADO">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('SÁBADO')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>

<div class="day-card" data-day="DOMINGO">
<div class="day-title">
<div>
<span><i class="fas fa-calendar-day"></i> DOMINGO</span>
<div class="day-date" id="date-DOMINGO"></div>
</div>
<span class="badge bg-primary badge-custom" id="count-DOMINGO">0</span>
</div>

<div class="day-routes" id="routes-DOMINGO" data-day="DOMINGO">
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
</div>

<button class="add-route-btn" onclick="addNewRouteRow('DOMINGO')">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>
</div>
</section>

<!-- Sección de Camionetas a Rellenar -->
<section class="refill-section">
<div class="refill-header">
<div class="refill-title">
<i class="fas fa-gas-pump"></i> Camionetas a Rellenar
<small class="text-muted ms-2">(Una sola vez por camioneta)</small>
</div>
<div>
<button class="btn btn-secondary-custom me-2" onclick="debugRefillState()">
<i class="fas fa-bug"></i> Depurar
</button>
<button class="btn btn-danger-custom me-2" onclick="clearAllMarks()">
<i class="fas fa-trash"></i> Limpiar Todo
</button>
<button class="refill-toggle" id="refillToggle">
<i class="fas fa-filter"></i> Mostrar Lista
</button>
</div>
</div>
<div class="refill-list" id="refillList" style="display: none;">
<div class="refill-text-header">
<div class="refill-text-title">Camionetas marcadas para rellenar</div>
<button class="copy-btn" onclick="copyRefillText()">
<i class="fas fa-copy"></i> Copiar
</button>
</div>
<div id="refillTextContent"></div>
</div>
</section>
</div>

<!-- Routes Tab -->
<div class="tab-pane fade" id="routes" role="tabpanel">
<section class="card-custom">
<div class="list-header">
<div class="list-title">
<i class="fas fa-route"></i> Lista de Rutas
</div>
<div class="list-stats">
<span class="stat-badge" id="routesCount">0 rutas</span>
<button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addRouteModal">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>
</div>

<div class="search-box mb-3">
<i class="fas fa-search"></i>
<input type="text" class="form-control" id="searchRoutes" placeholder="Buscar rutas...">
</div>

<div class="list-container">
<div class="list-content" id="routesList">
<div class="empty-state">
<i class="fas fa-route"></i>
<h4>No hay rutas registradas</h4>
<p>Agrega tu primera ruta usando el botón de arriba</p>
</div>
</div>
</div>
</section>
</div>

<!-- Drivers Tab -->
<div class="tab-pane fade" id="drivers" role="tabpanel">
<section class="card-custom">
<div class="list-header">
<div class="list-title">
<i class="fas fa-user-tie"></i> Lista de Choferes
</div>
<div class="list-stats">
<span class="stat-badge" id="driversCount">0 choferes</span>
<button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addDriverModal">
<i class="fas fa-plus"></i> Agregar Chofer
</button>
</div>
</div>

<div class="search-box mb-3">
<i class="fas fa-search"></i>
<input type="text" class="form-control" id="searchDrivers" placeholder="Buscar choferes...">
</div>

<div class="list-container">
<div class="list-content" id="driversList">
<div class="empty-state">
<i class="fas fa-user-tie"></i>
<h4>No hay choferes registrados</h4>
<p>Agrega tu primer chofer usando el botón de arriba</p>
</div>
</div>
</div>
</section>
</div>

<!-- Trucks Tab -->
<div class="tab-pane fade" id="trucks" role="tabpanel">
<section class="card-custom">
<div class="list-header">
<div class="list-title">
<i class="fas fa-truck-pickup"></i> Lista de Unidades
</div>
<div class="list-stats">
<span class="stat-badge" id="trucksCount">0 unidades</span>
<button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addTruckModal">
<i class="fas fa-plus"></i> Agregar Unidad
</button>
</div>
</div>

<div class="search-box mb-3">
<i class="fas fa-search"></i>
<input type="text" class="form-control" id="searchTrucks" placeholder="Buscar unidades...">
</div>

<div class="list-container">
<div class="list-content" id="trucksList">
<div class="empty-state">
<i class="fas fa-truck-pickup"></i>
<h4>No hay unidades registradas</h4>
<p>Agrega tu primera unidad usando el botón de arriba</p>
</div>
</div>
</div>
</section>
</div>

<!-- History Tab -->
<div class="tab-pane fade" id="history" role="tabpanel">
<section class="card-custom">
<h2 class="section-title">
<i class="fas fa-history"></i> Historial de Rutas
</h2>

<!-- Sistema de Filtros Simple -->
<div class="filter-section">
<div class="filter-row">
<div class="filter-group">
<label for="filterDate">Fecha</label>
<input type="date" class="form-control" id="filterDate">
</div>
<div class="filter-group">
<label for="filterRoute">Ruta</label>
<select class="form-select" id="filterRoute">
<option value="">Todas las rutas</option>
</select>
</div>
<div class="filter-group">
<label for="filterTruck">Unidad</label>
<select class="form-select" id="filterTruck">
<option value="">Todas las unidades</option>
</select>
</div>
<div class="filter-group">
<label for="filterDriver">Chofer</label>
<select class="form-select" id="filterDriver">
<option value="">Todos los choferes</option>
</select>
</div>
</div>
<div class="filter-actions">
<button class="btn btn-primary-custom" onclick="applyFilters()">
<i class="fas fa-filter"></i> Aplicar Filtros
</button>
<button class="btn btn-secondary-custom" onclick="clearFilters()">
<i class="fas fa-times"></i> Limpiar Filtros
</button>
</div>
<div class="active-filters" id="activeFilters"></div>
</div>

<!-- Información de Resultados y Acciones -->
<div class="results-info">
<div class="results-count" id="resultsCount">Mostrando 0 de 0 resultados</div>
<div class="export-buttons">
<button id="exportBtn" class="btn btn-sm btn-secondary-custom me-2">
<i class="fas fa-file-csv"></i> Exportar CSV
</button>
<button id="exportPDFBtn" class="btn btn-sm btn-info-custom me-2">
<i class="fas fa-file-pdf"></i> Exportar PDF
</button>
<button class="btn btn-sm btn-danger-custom" data-bs-toggle="modal" data-bs-target="#clearHistoryModal">
<i class="fas fa-trash-alt"></i> Limpiar
</button>
</div>
</div>

<!-- Tabla de Historial -->
<div class="table-container">
<table class="excel-table">
<thead>
<tr>
<th>Fecha</th>
<th>Ruta</th>
<th>Unidad</th>
<th>Chofer</th>
<th>Estado</th>
<th class="actions-cell">Acciones</th>
</tr>
</thead>
<tbody id="historyTableBody">
<tr>
<td colspan="6" class="text-center text-muted">No hay registros en el historial</td>
</tr>
</tbody>
</table>
</div>

<!-- Paginación -->
<div class="pagination-container">
<nav aria-label="Page navigation">
<ul class="pagination" id="historyPagination">
<!-- La paginación se generará dinámicamente -->
</ul>
</nav>
</div>

<!-- Danger Zone -->
<div class="danger-zone">
<h3 class="danger-zone-title">
<i class="fas fa-exclamation-triangle"></i> Zona de Peligro
</h3>
<p class="mb-3">Estas acciones son irreversibles y eliminarán permanentemente los datos.</p>
<div class="d-flex gap-2">
<button class="btn btn-danger-custom" data-bs-toggle="modal" data-bs-target="#resetDataModal">
<i class="fas fa-undo"></i> Restablecer Plantilla
</button>
</div>
</div>
</section>
</div>

<!-- Calendar Tab -->
<div class="tab-pane fade" id="calendar" role="tabpanel">
<!-- Selector de Fecha Compacto -->
<div class="date-selector-container">
  <label for="calendarDate" class="form-label text-white mb-1">
    Seleccionar fecha:
  </label>
  <input type="date" id="calendarDate" class="form-control date-input-custom" />
</div>

<section class="calendar-view">
<div class="calendar-header">
<div class="calendar-title" id="calendarTitle">
<i class="fas fa-calendar-alt"></i> Enero 2025
</div>
<div class="calendar-nav">
<div class="calendar-view-buttons">
<button class="calendar-view-btn active" onclick="setCalendarView('month')" data-view="month">
<i class="fas fa-calendar"></i> Mes
</button>
<button class="calendar-view-btn" onclick="setCalendarView('week')" data-view="week">
<i class="fas fa-calendar-week"></i> Semana
</button>
<button class="calendar-view-btn" onclick="setCalendarView('day')" data-view="day">
<i class="fas fa-calendar-day"></i> Día
</button>
<button class="calendar-view-btn" onclick="setCalendarView('list')" data-view="list">
<i class="fas fa-list"></i> Lista
</button>
<button class="calendar-view-btn" onclick="setCalendarView('compact')" data-view="compact">
<i class="fas fa-th"></i> Compacto
</button>
</div>
<button class="btn btn-secondary-custom" onclick="previousPeriod()">
<i class="fas fa-chevron-left"></i>
</button>
<button class="btn btn-primary-custom" onclick="goToToday()">
Hoy
</button>
<button class="btn btn-secondary-custom" onclick="nextPeriod()">
<i class="fas fa-chevron-right"></i>
</button>
</div>
</div>
<div id="calendarContainer">
<!-- El calendario se generará dinámicamente -->
</div>
</section>
</div>

<!-- Reports Tab -->
<div class="tab-pane fade" id="reports" role="tabpanel">
<section class="card-custom">
<h2 class="section-title">
<i class="fas fa-chart-bar"></i> Reportes y Estadísticas
</h2>

<!-- Report Filters -->
<div class="report-filters">
<div class="row">
<div class="col-md-4">
<label for="reportStartDate" class="form-label">Fecha Inicio</label>
<input type="date" class="form-control" id="reportStartDate">
</div>
<div class="col-md-4">
<label for="reportEndDate" class="form-label">Fecha Fin</label>
<input type="date" class="form-control" id="reportEndDate">
</div>
<div class="col-md-4 d-flex align-items-end">
<button class="btn btn-primary-custom w-100" onclick="generateReports()">
<i class="fas fa-sync"></i> Generar Reporte
</button>
</div>
</div>
</div>

<!-- Charts -->
<div class="row">
<div class="col-md-6">
<div class="card-custom">
<h3 class="section-title">
<i class="fas fa-chart-pie"></i> Rutas por Destino
</h3>
<div class="chart-container">
<canvas id="routesChart"></canvas>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card-custom">
<h3 class="section-title">
<i class="fas fa-chart-line"></i> Uso de Unidades
</h3>
<div class="chart-container">
<canvas id="trucksChart"></canvas>
</div>
</div>
</div>
</div>
</section>
</div>
</div>
</main>
</div>

<!-- Modals -->
<!-- Add Route Modal -->
<div class="modal fade" id="addRouteModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Agregar Nueva Ruta</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="newRouteForm">
<div class="mb-3">
<label for="newRouteName" class="form-label">Nombre de la Ruta</label>
<input type="text" class="form-control" id="newRouteName" required>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" id="saveNewRoute">Guardar</button>
</div>
</div>
</div>
</div>

<!-- Edit Route Modal -->
<div class="modal fade" id="editRouteModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Editar Ruta</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="editRouteForm">
<div class="mb-3">
<label for="editRouteName" class="form-label">Nombre de la Ruta</label>
<input type="text" class="form-control" id="editRouteName" required>
<input type="hidden" id="editRouteIndex">
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" id="updateRoute">Actualizar</button>
</div>
</div>
</div>
</div>

<!-- Add Driver Modal -->
<div class="modal fade" id="addDriverModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Agregar Nuevo Chofer</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="newDriverForm">
<div class="mb-3">
<label for="newDriverName" class="form-label">Nombre Completo del Chofer</label>
<input type="text" class="form-control" id="newDriverName" placeholder="Ej: Juan Pérez García" required>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" id="saveNewDriver">Guardar</button>
</div>
</div>
</div>
</div>

<!-- Edit Driver Modal -->
<div class="modal fade" id="editDriverModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Editar Chofer</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="editDriverForm">
<div class="mb-3">
<label for="editDriverName" class="form-label">Nombre Completo del Chofer</label>
<input type="text" class="form-control" id="editDriverName" placeholder="Ej: Juan Pérez García" required>
<input type="hidden" id="editDriverIndex">
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" id="updateDriver">Actualizar</button>
</div>
</div>
</div>
</div>

<!-- Add Truck Modal -->
<div class="modal fade" id="addTruckModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Agregar Nueva Unidad</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="newTruckForm">
<div class="mb-3">
<label for="newTruckNumber" class="form-label">Número de Unidad</label>
<input type="text" class="form-control" id="newTruckNumber" required>
</div>
<div class="mb-3">
<label for="newTruckModel" class="form-label">Modelo</label>
<input type="text" class="form-control" id="newTruckModel" required>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" id="saveNewTruck">Guardar</button>
</div>
</div>
</div>
</div>

<!-- Edit Truck Modal -->
<div class="modal fade" id="editTruckModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Editar Unidad</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="editTruckForm">
<div class="mb-3">
<label for="editTruckNumber" class="form-label">Número de Unidad</label>
<input type="text" class="form-control" id="editTruckNumber" required>
</div>
<div class="mb-3">
<label for="editTruckModel" class="form-label">Modelo</label>
<input type="text" class="form-control" id="editTruckModel" required>
</div>
<input type="hidden" id="editTruckIndex">
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" id="updateTruck">Actualizar</button>
</div>
</div>
</div>
</div>

<!-- Day List Modal -->
<div class="modal fade day-list-modal" id="dayListModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="day-list-header">
<div class="day-list-title" id="dayListTitle">Rutas del Día</div>
<div class="day-list-date" id="dayListDate">Fecha</div>
</div>
<div class="day-list-content" id="dayListContent">
<!-- Las rutas se cargarán dinámicamente -->
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
<button type="button" class="btn btn-primary-custom" onclick="addRouteToDay()">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>
</div>
</div>
</div>

<!-- Clear History Modal -->
<div class="modal fade" id="clearHistoryModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Limpiar Historial</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p>¿Está seguro de que desea limpiar todo el historial de rutas?</p>
<p class="text-danger">Esta acción eliminará permanentemente todos los registros de rutas pero mantendrá las rutas, choferes y unidades.</p>
<div class="form-check mb-3">
<input class="form-check-input" type="checkbox" id="confirmClearHistory">
<label class="form-check-label" for="confirmClearHistory">
Confirmo que deseo eliminar todo el historial
</label>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-danger-custom" id="confirmClearHistoryBtn" disabled>Limpiar Historial</button>
</div>
</div>
</div>
</div>

<!-- Reset Data Modal -->
<div class="modal fade" id="resetDataModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Restablecer Plantilla</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p>¿Está seguro de que desea restablecer la plantilla completa?</p>
<p class="text-danger">Esta acción eliminará permanentemente todos los datos y restaurará la aplicación a su estado inicial.</p>
<div class="form-check mb-3">
<input class="form-check-input" type="checkbox" id="confirmResetData">
<label class="form-check-label" for="confirmResetData">
Confirmo que deseo restablecer toda la aplicación
</label>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-danger-custom" id="confirmResetDataBtn" disabled>Restablecer Plantilla</button>
</div>
</div>
</div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// PASO 3: CONFIGURACIÓN DE FIREBASE
// PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyABEOcduBpaKCTWSj0UJbiQ09PRJPsTXHw",
  authDomain: "sistema-rutas-colaborativo.firebaseapp.com",
  projectId: "sistema-rutas-colaborativo",
  storageBucket: "sistema-rutas-colaborativo.firebasestorage.app",
  messagingSenderId: "653094221545",
  appId: "1:653094221545:web:ca296982c20df52f916278"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// App State - Sistema completo
const app = {
routes: [
'MELI', 'REFA MAÑANA', 'MARTINEZ', 'POZA RICA', 'PAPANTLA', 
'REFA TARDE', 'MISANTLA', 'PACHUCA', 'IXMIQUILPAN', 
'OAXACA CENTRO', 'OAXACA COSTA', 'CIUDAD VALLES', 
'TULANCINGO', 'VERACRUZ', 'ACAPULCO', 'RUTA CHICA',
'CAMIONETA OAXACA COSTA', 'CAMIONETA CIUDAD VALLES', 
'CAMIONETA MISANTLA', 'RUMPAQ CAPECHE', 'CAMIONETA PACHUCA', 
'CAMIONETA TEZIUTLAN'
],
drivers: [
'Alfredo García', 'Emilio López', 'Guevara Martínez', 'Nahim Hernández', 'Juan Pérez', 'Rafael Rodríguez', 
'Efrén Díaz', 'Tomás Sánchez', 'Guillermo Torres', 'Julio Ramírez', 'Bedolla Morales', 
'Fabian Castro', 'Javier Vargas', 'Posadas Silva', 'Alan Ruiz', 'Omar Mendoza', 
'César Jiménez', 'Jorge Aguilar', 'Marcelo Ortiz', 'William Clark'
],
trucks: [
{ number: '56', model: 'SILVERADO 3500' },
{ number: '76', model: 'CRAFTER' },
{ number: '79', model: 'TORNADO' },
{ number: '82', model: 'CRAFTER' },
{ number: '98', model: 'SAVEIRO' },
{ number: '108', model: 'SAVEIRO' },
{ number: '110', model: 'CRAFTER' },
{ number: '120', model: 'SAVEIRO' },
{ number: '126', model: 'SAVEIRO' },
{ number: '137', model: 'CRAFTER' },
{ number: '138', model: 'KANGOO' },
{ number: '149', model: 'SAVEIRO' },
{ number: '150', model: 'SAVEIRO' },
{ number: '158', model: 'KANGOO' },
{ number: '166', model: 'HIACE' },
{ number: '170', model: 'SILVERADO' },
{ number: '179', model: 'TORNADO' },
{ number: '121', model: 'SAVEIRO' }
],
routeRecords: [],
currentWeek: [],
currentWeekStart: null,
editingRoute: null,
editingRouteId: null,
currentPage: 1,
itemsPerPage: 15,
charts: {
routes: null,
trucks: null,
drivers: null,
daily: null
},
history: [],
historyIndex: -1,
maxHistorySize: 50,
notifications: [],
isOnline: navigator.onLine,
markedTrucks: new Map(),
// Estado del filtrado simple
filters: {
date: '',
route: '',
truck: '',
driver: ''
},
currentMonth: new Date(2025, 0, 1), // Enero 2025
currentWeekStart: new Date(2025, 0, 6), // Lunes 6 de Enero 2025
currentDay: new Date(2025, 0, 6), // Día actual
filteredData: [],
calendarView: 'month', // 'month', 'week', 'day', 'list', 'compact'
selectedDate: null
};

// Función para formatear nombre de chofer
function formatDriverName(fullName) {
if (!fullName) return '';
const parts = fullName.trim().split(' ');
if (parts.length === 1) return parts[0];
return `${parts[0]} ${parts[1].charAt(0)}.`;
}

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
// Cargar datos desde Firebase en lugar de localStorage
loadDataFromFirebase();

if (app.routeRecords.length === 0) {
addSampleData();
}

setupEventListeners();

const today = new Date();
today.setFullYear(2025);
const lastMonth = new Date(today);
lastMonth.setMonth(today.getMonth() - 1);

document.getElementById('reportStartDate').valueAsDate = lastMonth;
document.getElementById('reportEndDate').valueAsDate = today;

initializeWeek();
updateUI();
updateStatistics();

document.getElementById('reports-tab').addEventListener('shown.bs.tab', function() {
generateReports();
});

updateConnectionStatus();

window.addEventListener('online', updateConnectionStatus);
window.addEventListener('offline', updateConnectionStatus);

setupUndoRedo();
checkNotifications();

// Inicializar sistema de filtrado simple
initializeSimpleFilters();

// Inicializar calendario
initializeCalendar();
});

// ============================================
// PASO 4: REEMPLAZAR LAS FUNCIONES DE GUARDADO Y CARGA
// ============================================

// Cargar datos desde Firebase y configurar listeners en tiempo real
function loadDataFromFirebase() {
  console.log("Cargando datos y configurando listeners de Firebase...");

  // Listener para Rutas
  db.collection('appData').doc('routes').onSnapshot(doc => {
    if (doc.exists) {
      app.routes = doc.data().items || [];
      console.log("Rutas cargadas:", app.routes);
      updateUI(); // Actualizar la UI cada vez que los datos cambien
    } else {
      // Si no existe el documento, lo creamos con los datos iniciales
      db.collection('appData').doc('routes').set({ items: app.routes });
    }
  });

  // Listener para Choferes
  db.collection('appData').doc('drivers').onSnapshot(doc => {
    if (doc.exists) {
      app.drivers = doc.data().items || [];
      console.log("Choferes cargados:", app.drivers);
      updateUI();
    } else {
      db.collection('appData').doc('drivers').set({ items: app.drivers });
    }
  });

  // Listener para Unidades
  db.collection('appData').doc('trucks').onSnapshot(doc => {
    if (doc.exists) {
      app.trucks = doc.data().items || [];
      console.log("Unidades cargadas:", app.trucks);
      updateUI();
    } else {
      db.collection('appData').doc('trucks').set({ items: app.trucks });
    }
  });

  // Listener para Registros de Rutas
  db.collection('appData').doc('routeRecords').onSnapshot(doc => {
    if (doc.exists) {
      app.routeRecords = doc.data().items || [];
      console.log("Registros de rutas cargados:", app.routeRecords);
      updateUI();
    } else {
      db.collection('appData').doc('routeRecords').set({ items: app.routeRecords });
    }
  });

  // Listener para Camionetas Marcadas
  db.collection('appData').doc('markedTrucks').onSnapshot(doc => {
    if (doc.exists) {
      const markedArray = doc.data().items || [];
      app.markedTrucks = new Map(markedArray.map(item => [item.key, item.value]));
      console.log("Camionetas marcadas cargadas:", app.markedTrucks);
      updateUI();
    } else {
      // Convertir el Map a un array para guardarlo
      const markedArray = Array.from(app.markedTrucks.entries()).map(([key, value]) => ({ key, value }));
      db.collection('appData').doc('markedTrucks').set({ items: markedArray });
    }
  });
}

// Guardar datos en Firebase
async function saveDataToFirebase() {
  try {
    console.log("Guardando datos en Firebase...");
    const batch = db.batch();

    const routesRef = db.collection('appData').doc('routes');
    batch.set(routesRef, { items: app.routes }, { merge: true });

    const driversRef = db.collection('appData').doc('drivers');
    batch.set(driversRef, { items: app.drivers }, { merge: true });

    const trucksRef = db.collection('appData').doc('trucks');
    batch.set(trucksRef, { items: app.trucks }, { merge: true });

    const recordsRef = db.collection('appData').doc('routeRecords');
    batch.set(recordsRef, { items: app.routeRecords }, { merge: true });

    // Convertir el Map de markedTrucks a un array para guardarlo
    const markedArray = Array.from(app.markedTrucks.entries()).map(([key, value]) => ({ key, value }));
    const markedRef = db.collection('appData').doc('markedTrucks');
    batch.set(markedRef, { items: markedArray }, { merge: true });

    await batch.commit();
    console.log("Datos guardados exitosamente en Firebase.");
    showToast('Datos sincronizados con la nube', 'success');
  } catch (error) {
    console.error("Error al guardar datos en Firebase: ", error);
    showToast('Error al guardar datos', 'error');
  }
}

// Función para formatear nombre de chofer
function formatDriverName(fullName) {
if (!fullName) return '';
const parts = fullName.trim().split(' ');
if (parts.length === 1) return parts[0];
return `${parts[0]} ${parts[1].charAt(0)}.`;
}

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
loadDataFromFirebase();

if (app.routeRecords.length === 0) {
addSampleData();
}

setupEventListeners();

const today = new Date();
today.setFullYear(2025);
const lastMonth = new Date(today);
lastMonth.setMonth(today.getMonth() - 1);

document.getElementById('reportStartDate').valueAsDate = lastMonth;
document.getElementById('reportEndDate').valueAsDate = today;

initializeWeek();
updateUI();
updateStatistics();

document.getElementById('reports-tab').addEventListener('shown.bs.tab', function() {
generateReports();
});

updateConnectionStatus();

window.addEventListener('online', updateConnectionStatus);
window.addEventListener('offline', updateConnectionStatus);

setupUndoRedo();
checkNotifications();

// Inicializar sistema de filtrado simple
initializeSimpleFilters();

// Inicializar calendario
initializeCalendar();
});

// ============================================
// VISTA DE CALENDARIO MEJORADA CON 5 VISTAS
// ============================================

function initializeCalendar() {
  // Sincronizar el selector con la fecha actual según la vista
  updateCalendarDateSelector();
  renderCalendar();
}

function updateCalendarDateSelector() {
  const dateSelector = document.getElementById('calendarDate');
  let dateToShow;
  
  switch(app.calendarView) {
    case 'month':
      dateToShow = new Date(app.currentMonth.getFullYear(), app.currentMonth.getMonth(), 1);
      break;
    case 'week':
      dateToShow = new Date(app.currentWeekStart);
      break;
    case 'day':
      dateToShow = new Date(app.currentDay);
      break;
    default:
      dateToShow = new Date(app.currentMonth.getFullYear(), app.currentMonth.getMonth(), 1);
  }
  
  // Formatear la fecha para el input type="date"
  const year = dateToShow.getFullYear();
  const month = String(dateToShow.getMonth() + 1).padStart(2, '0');
  const day = String(dateToShow.getDate()).padStart(2, '0');
  dateSelector.value = `${year}-${month}-${day}`;
}

function renderCalendar() {
const container = document.getElementById('calendarContainer');
const year = app.currentMonth.getFullYear();
const month = app.currentMonth.getMonth();

// Actualizar título según la vista
let titleText = '';
switch(app.calendarView) {
case 'month':
const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
titleText = `${monthNames[month]} ${year}`;
break;
case 'week':
const weekStart = new Date(app.currentWeekStart);
const weekEnd = new Date(weekStart);
weekEnd.setDate(weekStart.getDate() + 6);
titleText = `Semana del ${weekStart.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} al ${weekEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}`;
break;
case 'day':
const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
titleText = `${dayNames[app.currentDay.getDay()]}, ${app.currentDay.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`;
break;
case 'list':
const listMonthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
titleText = `Lista de Rutas - ${listMonthNames[month]} ${year}`;
break;
case 'compact':
const compactMonthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
titleText = `${compactMonthNames[month]} ${year}`;
break;
}

document.getElementById('calendarTitle').innerHTML = `
<i class="fas fa-calendar-alt"></i> ${titleText}
`;

switch(app.calendarView) {
case 'month':
renderMonthView(container, year, month);
break;
case 'week':
renderWeekView(container);
break;
case 'day':
renderDayView(container);
break;
case 'list':
renderListView(container, year, month);
break;
case 'compact':
renderCompactView(container, year, month);
break;
}
}

function renderWeekView(container) {
  const weekDays = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'];
  const weekStart = new Date(app.currentWeekStart);
  
  let weekHTML = `
    <div class="calendar-week-view">
      <div class="calendar-week-header">
        <div class="calendar-week-title">
          <i class="fas fa-calendar-week"></i> 
          Semana del ${weekStart.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} al 
          ${new Date(weekStart.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
        </div>
      </div>
      
      <div class="calendar-week-grid-compact">
        <!-- Encabezado de tiempo -->
        <div class="calendar-week-time-header">
          <i class="fas fa-clock"></i>
        </div>
  `;

  // Generar encabezados de días
  weekDays.forEach((dayName, index) => {
    const currentDate = new Date(weekStart);
    currentDate.setDate(weekStart.getDate() + index);
    currentDate.setFullYear(2025);
    const dateStr = toLocalDateString(currentDate);
    const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);
    const isToday = app.currentDay.toDateString() === currentDate.toDateString();

    weekHTML += `
      <div class="calendar-week-day-header-compact ${isToday ? 'today' : ''}">
        <span class="day-name">${dayName.substring(0, 3)}</span>
        <span class="day-number">${currentDate.getDate()}</span>
        ${dayRoutes.length > 0 ? `<span class="route-count">${dayRoutes.length}</span>` : ''}
      </div>
    `;
  });

  // Generar contenido de días
  weekHTML += `
        <!-- Espacio vacío bajo encabezado de tiempo -->
        <div style="background: #f8f9fa; border-bottom: 1px solid var(--medium-gray);"></div>
  `;

  weekDays.forEach((dayName, index) => {
    const currentDate = new Date(weekStart);
    currentDate.setDate(weekStart.getDate() + index);
    currentDate.setFullYear(2025);
    const dateStr = toLocalDateString(currentDate);
    const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);
    const markedRoutes = dayRoutes.filter(r => app.markedTrucks.has(r.truck));
    const isToday = app.currentDay.toDateString() === currentDate.toDateString();

    weekHTML += `
      <div class="calendar-week-day-content-compact ${isToday ? 'today' : ''}">
        <div class="calendar-week-day-indicators">
          ${dayRoutes.length > 0 ? `<span class="calendar-week-indicator">${dayRoutes.length}</span>` : ''}
          ${markedRoutes.length > 0 ? `<span class="calendar-week-indicator marked">${markedRoutes.length}</span>` : ''}
        </div>
        
        <div class="calendar-week-routes-list">
    `;

    if (dayRoutes.length === 0) {
      weekHTML += `
        <div class="calendar-week-empty-compact">
          <i class="fas fa-route"></i>
          <span>Sin rutas</span>
        </div>
      `;
    } else {
      dayRoutes.forEach(route => {
        const isMarked = app.markedTrucks.has(route.truck);
        const driverShortName = formatDriverName(route.driver);
        
        weekHTML += `
          <div class="calendar-week-route-compact ${isMarked ? 'marked' : ''}" 
               title="${route.truck} - ${route.route} - ${driverShortName}"
               onclick="showRouteDetails(${route.id})">
            <div class="calendar-week-route-text">
              ${route.truck}-${route.route}-${driverShortName}
            </div>
            <div class="calendar-week-route-actions-compact">
              <button class="calendar-week-route-btn-compact fuel" 
                      onclick="event.stopPropagation(); toggleTruckRefill(${route.id})" 
                      title="${isMarked ? 'Desmarcar' : 'Marcar'} para rellenar">
                <i class="fas fa-gas-pump"></i>
              </button>
              <button class="calendar-week-route-btn-compact delete" 
                      onclick="event.stopPropagation(); deleteRoute(${route.id})" 
                      title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
    }

    weekHTML += `
        </div>
      </div>
    `;
  });

  weekHTML += `
      </div>
    </div>
  `;

  container.innerHTML = weekHTML;
}

function renderDayView(container) {
const dateStr = toLocalDateString(app.currentDay);
const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);
const markedRoutes = dayRoutes.filter(r => app.markedTrucks.has(r.truck));
const dayName = app.currentDay.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

let dayHTML = `
<div class="calendar-day-view">
<div class="calendar-day-header">
<div class="calendar-day-title">
<i class="fas fa-calendar-day"></i> ${dayName.charAt(0).toUpperCase() + dayName.slice(1)}
</div>
<div class="calendar-day-info">
<div class="calendar-day-date">${dateStr}</div>
<div class="calendar-day-stats">
<div class="calendar-day-stat">
<i class="fas fa-route"></i>
 ${dayRoutes.length} Ruta${dayRoutes.length !== 1 ? 's' : ''}
</div>
 ${markedRoutes.length > 0 ? `
<div class="calendar-day-stat marked">
<i class="fas fa-gas-pump"></i>
 ${markedRoutes.length} Marcada${markedRoutes.length !== 1 ? 's' : ''}
</div>
` : ''}
</div>
</div>
<div class="calendar-day-content">
<div class="calendar-day-routes-list">
<div class="calendar-day-routes-header">
<div class="calendar-day-routes-title">
<i class="fas fa-list"></i> Rutas del Día
</div>
<button class="btn btn-primary-custom" onclick="addRouteToDay()">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>
`;

if (dayRoutes.length === 0) {
dayHTML += `
<div class="empty-state">
<i class="fas fa-route"></i>
<h4>No hay rutas programadas</h4>
<p>Este día no tiene rutas asignadas</p>
</div>
`;
} else {
dayRoutes.forEach(route => {
const isMarked = app.markedTrucks.has(route.truck);
const driverShortName = formatDriverName(route.driver);
    
dayHTML += `
<div class="calendar-day-route-card ${isMarked ? 'marked' : ''}">
<div class="calendar-day-route-header">
<div class="calendar-day-route-title">${route.truck}-${route.route}-${driverShortName}</div>
 ${isMarked ? '<span class="badge bg-warning">⛽ Marcada para rellenar</span>' : ''}
</div>
<div class="calendar-day-route-details">
<div class="calendar-day-route-detail">
<i class="fas fa-truck"></i>
<span class="calendar-day-route-detail-label">Unidad:</span>
<span class="calendar-day-route-detail-value">${route.truck}</span>
</div>
<div class="calendar-day-route-detail">
<i class="fas fa-route"></i>
<span class="calendar-day-route-detail-label">Ruta:</span>
<span class="calendar-day-route-detail-value">${route.route}</span>
</div>
<div class="calendar-day-route-detail">
<i class="fas fa-user-tie"></i>
<span class="calendar-day-route-detail-label">Chofer:</span>
<span class="calendar-day-route-detail-value">${route.driver}</span>
</div>
</div>
<div class="calendar-day-route-actions">
<button class="btn btn-sm btn-outline-primary" onclick="showRouteDetails(${route.id})">
<i class="fas fa-eye"></i> Ver Detalles
</button>
<button class="btn btn-sm btn-outline-warning" onclick="toggleTruckRefill(${route.id})">
<i class="fas fa-gas-pump"></i> ${isMarked ? 'Desmarcar' : 'Marcar'} Rellenar
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRoute(${route.id})">
<i class="fas fa-trash"></i> Eliminar
</button>
</div>
</div>
`;
});
}

dayHTML += `
</div>
</div>
</div>
`;

container.innerHTML = dayHTML;
}

function renderMonthView(container, year, month) {
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const prevLastDay = new Date(year, month, 0);
const firstDayIndex = firstDay.getDay();
const lastDayIndex = lastDay.getDay();
const prevDays = prevLastDay.getDate();
const lastDate = lastDay.getDate();
const nextDays = 7 - lastDayIndex - 1;

let calendarHTML = '<div class="calendar-grid">';

// Días de la semana
const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
dayNames.forEach(day => {
calendarHTML += `<div class="calendar-day-header">${day}</div>`;
});

// Días del mes anterior
for (let x = firstDayIndex; x > 0; x--) {
calendarHTML += `<div class="calendar-day other-month">
<div class="calendar-day-number">${prevDays - x + 1}</div>
</div>`;
}

// Días del mes actual
const today = new Date();
today.setFullYear(2025);
today.setHours(0, 0, 0, 0);

for (let i = 1; i <= lastDate; i++) {
const currentDate = new Date(year, month, i);
currentDate.setFullYear(2025);
const dateStr = toLocalDateString(currentDate);
const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);
const isToday = today.getTime() === currentDate.getTime();
const markedRoutes = dayRoutes.filter(r => app.markedTrucks.has(r.truck));

calendarHTML += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="selectCalendarDate('${dateStr}')">
<div class="calendar-day-number">
<span>${i}</span>
<div class="calendar-day-stats">`;

if (dayRoutes.length > 0) {
calendarHTML += `<span class="route-count-badge">${dayRoutes.length}</span>`;
}
if (markedRoutes.length > 0) {
calendarHTML += `<span class="marked-count-badge">${markedRoutes.length}</span>`;
}

calendarHTML += `</div>
</div>
<div class="calendar-day-routes">`;

// Mostrar TODAS las rutas del día con formato completo "camioneta-ruta-chofer"
dayRoutes.forEach(route => {
const isMarked = app.markedTrucks.has(route.truck);
const driverShortName = formatDriverName(route.driver);
    
calendarHTML += `<div class="calendar-route-item ${isMarked ? 'marked' : ''}" 
title="${route.truck} - ${route.route} - ${driverShortName}"
onclick="event.stopPropagation(); showRouteDetails(${route.id})">
 ${route.truck}-${route.route}-${driverShortName}
</div>`;
});

if (dayRoutes.length === 0) {
calendarHTML += `<div style="color: #999; font-size: 0.6rem; text-align: center; padding: 1rem;">
Sin rutas
</div>`;
}

calendarHTML += `</div></div>`;
}

// Días del mes siguiente
for (let j = 1; j <= nextDays; j++) {
calendarHTML += `<div class="calendar-day other-month">
<div class="calendar-day-number">${j}</div>
</div>`;
}

calendarHTML += '</div>';
container.innerHTML = calendarHTML;
}

function renderListView(container, year, month) {
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

let listHTML = `
<div class="calendar-list-view">
<div class="calendar-list-header">
<div class="calendar-list-title">
<i class="fas fa-list"></i> Lista de Rutas - ${monthNames[month]} ${year}
</div>
<button class="btn btn-primary-custom" onclick="addRouteToMonth()">
<i class="fas fa-plus"></i> Agregar Ruta
</button>
</div>
<div class="calendar-list-content">
`;

let hasRoutes = false;

for (let i = 1; i <= lastDay.getDate(); i++) {
const currentDate = new Date(year, month, i);
currentDate.setFullYear(2025);
const dateStr = toLocalDateString(currentDate);
const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);

if (dayRoutes.length > 0) {
hasRoutes = true;
const dayName = currentDate.toLocaleDateString('es-ES', { weekday: 'long' });
const formattedDate = currentDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

listHTML += `
<div class="calendar-list-day">
<div class="calendar-list-day-header">
<div class="calendar-list-day-title">
 ${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${i}
</div>
<div class="text-muted">${formattedDate}</div>
</div>
<div class="calendar-list-day-routes">
`;

dayRoutes.forEach(route => {
const isMarked = app.markedTrucks.has(route.truck);
const driverShortName = formatDriverName(route.driver);
    
listHTML += `
<div class="calendar-list-route ${isMarked ? 'marked' : ''}">
<div class="calendar-list-route-info">
<span class="calendar-list-route-full">${route.truck}-${route.route}-${driverShortName}</span>
</div>
<div class="calendar-list-route-actions">
<button class="btn btn-sm btn-outline-primary" onclick="showRouteDetails(${route.id})">
<i class="fas fa-eye"></i>
</button>
<button class="btn btn-sm btn-outline-warning" onclick="toggleTruckRefill(${route.id})">
<i class="fas fa-gas-pump"></i>
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRoute(${route.id})">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
`;
});

listHTML += `</div></div>`;
}
}

if (!hasRoutes) {
listHTML += `
<div class="empty-state">
<i class="fas fa-calendar-times"></i>
<h4>No hay rutas este mes</h4>
<p>Agrega rutas usando el botón de arriba</p>
</div>
`;
}

listHTML += `</div></div>`;
container.innerHTML = listHTML;
}

function renderCompactView(container, year, month) {
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const prevLastDay = new Date(year, month, 0);
const firstDayIndex = firstDay.getDay();
const lastDayIndex = lastDay.getDay();
const prevDays = prevLastDay.getDate();
const lastDate = lastDay.getDate();
const nextDays = 7 - lastDayIndex - 1;

let compactHTML = '<div class="calendar-compact-view">';

// Días de la semana
const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
dayNames.forEach(day => {
compactHTML += `<div style="background: var(--primary-color); color: white; padding: 0.5rem; text-align: center; font-weight: 600;">${day}</div>`;
});

// Días del mes anterior
for (let x = firstDayIndex; x > 0; x--) {
compactHTML += `<div class="calendar-compact-day other-month">
<div class="calendar-compact-day-number">${prevDays - x + 1}</div>
</div>`;
}

// Días del mes actual
const today = new Date();
today.setFullYear(2025);
today.setHours(0, 0, 0, 0);

for (let i = 1; i <= lastDate; i++) {
const currentDate = new Date(year, month, i);
currentDate.setFullYear(2025);
const dateStr = toLocalDateString(currentDate);
const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);
const isToday = today.getTime() === currentDate.getTime();

compactHTML += `<div class="calendar-compact-day ${isToday ? 'today' : ''} ${dayRoutes.length > 0 ? 'has-routes' : ''}" 
onclick="selectCalendarDate('${dateStr}')">
<div class="calendar-compact-day-number">${i}</div>`;

if (dayRoutes.length > 0) {
compactHTML += `<div class="calendar-compact-day-routes">${dayRoutes.length} ruta${dayRoutes.length > 1 ? 's' : ''}</div>`;
}

compactHTML += `</div>`;
}

// Días del mes siguiente
for (let j = 1; j <= nextDays; j++) {
compactHTML += `<div class="calendar-compact-day other-month">
<div class="calendar-compact-day-number">${j}</div>
</div>`;
}

compactHTML += '</div>';
container.innerHTML = compactHTML;
}

function setCalendarView(view) {
app.calendarView = view;
    
// Actualizar botones
document.querySelectorAll('.calendar-view-btn').forEach(btn => {
btn.classList.remove('active');
if (btn.dataset.view === view) {
btn.classList.add('active');
}
});

updateCalendarDateSelector();
renderCalendar();
}

function previousPeriod() {
switch(app.calendarView) {
case 'month':
app.currentMonth.setMonth(app.currentMonth.getMonth() - 1);
break;
case 'week':
app.currentWeekStart.setDate(app.currentWeekStart.getDate() - 7);
break;
case 'day':
app.currentDay.setDate(app.currentDay.getDate() - 1);
break;
}
updateCalendarDateSelector();
renderCalendar();
}

function nextPeriod() {
switch(app.calendarView) {
case 'month':
app.currentMonth.setMonth(app.currentMonth.getMonth() + 1);
break;
case 'week':
app.currentWeekStart.setDate(app.currentWeekStart.getDate() + 7);
break;
case 'day':
app.currentDay.setDate(app.currentDay.getDate() + 1);
break;
}
updateCalendarDateSelector();
renderCalendar();
}

function goToToday() {
const today = new Date();
today.setFullYear(2025);
    
switch(app.calendarView) {
case 'month':
app.currentMonth = new Date(2025, today.getMonth(), 1);
break;
case 'week':
const currentDay = today.getDay();
const monday = new Date(today);
monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
app.currentWeekStart = monday;
break;
case 'day':
app.currentDay = today;
break;
}
updateCalendarDateSelector();
renderCalendar();
}

function selectCalendarDate(dateStr) {
app.selectedDate = dateStr;
showDayListModal(dateStr);
}

function showDayListModal(dateStr) {
const date = new Date(dateStr);
const dayRoutes = app.routeRecords.filter(r => r.date === dateStr);
const markedRoutes = dayRoutes.filter(r => app.markedTrucks.has(r.truck));

// Actualizar título y fecha del modal
const dayName = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
document.getElementById('dayListTitle').textContent = `Rutas del ${dayName.charAt(0).toUpperCase() + dayName.slice(1)}`;
document.getElementById('dayListDate').textContent = dateStr;

// Generar contenido de rutas
let contentHTML = '';
if (dayRoutes.length === 0) {
contentHTML = `
<div class="empty-state">
<i class="fas fa-route"></i>
<h4>No hay rutas programadas</h4>
<p>Este día no tiene rutas asignadas</p>
</div>
`;
} else {
dayRoutes.forEach(route => {
const isMarked = app.markedTrucks.has(route.truck);
const driverShortName = formatDriverName(route.driver);
    
contentHTML += `
<div class="day-list-route ${isMarked ? 'marked' : ''}">
<div class="day-list-route-header">
<div class="day-list-route-title">${route.truck}-${route.route}-${driverShortName}</div>
 ${isMarked ? '<span class="badge bg-warning">⛽ Marcada para rellenar</span>' : ''}
</div>
<div class="day-list-route-details">
<div class="day-list-route-detail">
<i class="fas fa-truck"></i>
<span>Unidad: <strong>${route.truck}</strong></span>
</div>
<div class="day-list-route-detail">
<i class="fas fa-route"></i>
<span>Ruta: <strong>${route.route}</strong></span>
</div>
<div class="day-list-route-detail">
<i class="fas fa-user-tie"></i>
<span>Chofer: <strong>${route.driver}</strong></span>
</div>
</div>
<div class="mt-2">
<button class="btn btn-sm btn-outline-primary" onclick="showRouteDetails(${route.id})">
<i class="fas fa-eye"></i> Ver Detalles
</button>
<button class="btn btn-sm btn-outline-warning" onclick="toggleTruckRefill(${route.id})">
<i class="fas fa-gas-pump"></i> ${isMarked ? 'Desmarcar' : 'Marcar'} Rellenar
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRoute(${route.id})">
<i class="fas fa-trash"></i> Eliminar
</button>
</div>
</div>
`;
});
}

document.getElementById('dayListContent').innerHTML = contentHTML;

// Guardar la fecha seleccionada para agregar rutas
app.selectedDate = dateStr;

// Mostrar modal
const modal = new bootstrap.Modal(document.getElementById('dayListModal'));
modal.show();
}

function showRouteDetails(routeId) {
const record = app.routeRecords.find(r => r.id === routeId);
if (!record) return;

// Crear un modal temporal para mostrar detalles
const modalHTML = `
<div class="modal fade" id="routeDetailsModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Detalles de Ruta</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row mb-3">
<div class="col-4"><strong>Ruta:</strong></div>
<div class="col-8">${record.route}</div>
</div>
<div class="row mb-3">
<div class="col-4"><strong>Unidad:</strong></div>
<div class="col-8">${record.truck}</div>
</div>
<div class="row mb-3">
<div class="col-4"><strong>Chofer:</strong></div>
<div class="col-8">${record.driver}</div>
</div>
<div class="row mb-3">
<div class="col-4"><strong>Fecha:</strong></div>
<div class="col-8">${formatDate(record.date)}</div>
</div>
<div class="row">
<div class="col-4"><strong>Estado:</strong></div>
<div class="col-8">
<span class="badge ${app.markedTrucks.has(record.truck) ? 'bg-warning' : 'bg-success'}">
 ${app.markedTrucks.has(record.truck) ? 'Marcada para rellenar' : 'Normal'}
</span>
</div>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
<button type="button" class="btn btn-primary-custom" onclick="editRouteFromCalendar(${routeId})">
<i class="fas fa-edit"></i> Editar
</button>
</div>
</div>
</div>
</div>
`;

// Agregar modal al DOM
document.body.insertAdjacentHTML('beforeend', modalHTML);
const modal = new bootstrap.Modal(document.getElementById('routeDetailsModal'));
modal.show();

// Eliminar modal del DOM cuando se cierre
document.getElementById('routeDetailsModal').addEventListener('hidden.bs.modal', function() {
this.remove();
});
}

function editRouteFromCalendar(routeId) {
// Cerrar el modal de detalles
bootstrap.Modal.getInstance(document.getElementById('routeDetailsModal')).hide();
    
// Cerrar el modal de lista del día
bootstrap.Modal.getInstance(document.getElementById('dayListModal')).hide();
    
// Navegar a la semana de la ruta
editRouteFromDashboard(routeId);
}

function addRouteToDay() {
if (!app.selectedDate) return;

// Cerrar modal de lista del día
bootstrap.Modal.getInstance(document.getElementById('dayListModal')).hide();

// Navegar a la semana y agregar ruta
navigateToDate(app.selectedDate);

// Cambiar a dashboard
const dashboardTab = document.getElementById('dashboard-tab');
const tab = new bootstrap.Tab(dashboardTab);
tab.show();

// Esperar a que cargue y agregar ruta
setTimeout(() => {
const dayName = new Date(app.selectedDate).toLocaleDateString('es-ES', { weekday: 'long' }).toUpperCase();
addNewRouteRow(dayName);
}, 500);
}

function addRouteToMonth() {
// Abrir modal para seleccionar fecha y agregar ruta
const modalHTML = `
<div class="modal fade" id="addRouteToMonthModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Agregar Ruta al Mes</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="mb-3">
<label for="routeDate" class="form-label">Seleccionar Fecha</label>
<input type="date" class="form-control" id="routeDate" min="${app.currentMonth.getFullYear()}-${String(app.currentMonth.getMonth() + 1).padStart(2, '0')}-01" max="${new Date(app.currentMonth.getFullYear(), app.currentMonth.getMonth() + 1, 0).toISOString().split('T')[0]}">
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="button" class="btn btn-primary-custom" onclick="confirmAddRouteToMonth()">
Agregar Ruta
</button>
</div>
</div>
</div>
</div>
`;

document.body.insertAdjacentHTML('beforeend', modalHTML);
const modal = new bootstrap.Modal(document.getElementById('addRouteToMonthModal'));
modal.show();

document.getElementById('addRouteToMonthModal').addEventListener('hidden.bs.modal', function() {
this.remove();
});
}

function confirmAddRouteToMonth() {
const dateInput = document.getElementById('routeDate');
if (!dateInput.value) {
showToast('Por favor seleccione una fecha', 'error');
return;
}

// Cerrar modal
bootstrap.Modal.getInstance(document.getElementById('addRouteToMonthModal')).hide();

// Navegar a la fecha y agregar ruta
navigateToDate(dateInput.value);

// Cambiar a dashboard
const dashboardTab = document.getElementById('dashboard-tab');
const tab = new bootstrap.Tab(dashboardTab);
tab.show();

// Esperar y agregar ruta
setTimeout(() => {
const dayName = new Date(dateInput.value).toLocaleDateString('es-ES', { weekday: 'long' }).toUpperCase();
addNewRouteRow(dayName);
}, 500);
}

// ============================================
// SISTEMA DE FILTRADO SIMPLE
// ============================================

function initializeSimpleFilters() {
// Llenar opciones de filtros
updateFilterOptions();
    
// Configurar listeners
document.getElementById('filterDate').addEventListener('change', applyFilters);
document.getElementById('filterRoute').addEventListener('change', applyFilters);
document.getElementById('filterTruck').addEventListener('change', applyFilters);
document.getElementById('filterDriver').addEventListener('change', applyFilters);

// Aplicar filtros iniciales
applyFilters();
}

function updateFilterOptions() {
// Actualizar opciones de rutas
const routeSelect = document.getElementById('filterRoute');
routeSelect.innerHTML = '<option value="">Todas las rutas</option>';
app.routes.forEach(route => {
routeSelect.innerHTML += `<option value="${route}">${route}</option>`;
});

// Actualizar opciones de unidades
const truckSelect = document.getElementById('filterTruck');
truckSelect.innerHTML = '<option value="">Todas las unidades</option>';
app.trucks.forEach(truck => {
truckSelect.innerHTML += `<option value="${truck.number}">${truck.number}</option>`;
});

// Actualizar opciones de choferes
const driverSelect = document.getElementById('filterDriver');
driverSelect.innerHTML = '<option value="">Todos los choferes</option>';
app.drivers.forEach(driver => {
driverSelect.innerHTML += `<option value="${driver}">${formatDriverName(driver)}</option>`;
});
}

function applyFilters() {
// Obtener valores de filtros
app.filters.date = document.getElementById('filterDate').value;
app.filters.route = document.getElementById('filterRoute').value;
app.filters.truck = document.getElementById('filterTruck').value;
app.filters.driver = document.getElementById('filterDriver').value;

// Filtrar datos
app.filteredData = app.routeRecords.filter(record => {
let match = true;

if (app.filters.date && record.date !== app.filters.date) {
match = false;
}
if (app.filters.route && record.route !== app.filters.route) {
match = false;
}
if (app.filters.truck && record.truck !== app.filters.truck) {
match = false;
}
if (app.filters.driver) {
const driverFullName = app.drivers.find(d => formatDriverName(d) === app.filters.driver);
if (driverFullName && record.driver !== driverFullName) {
match = false;
}
}

return match;
});

// Actualizar UI
updateHistoryTable();
updateResultsInfo();
updatePagination();
updateActiveFilters();
}

function clearFilters() {
// Limpiar valores de filtros
document.getElementById('filterDate').value = '';
document.getElementById('filterRoute').value = '';
document.getElementById('filterTruck').value = '';
document.getElementById('filterDriver').value = '';

// Resetear estado
app.filters = {
date: '',
route: '',
truck: '',
driver: ''
};

// Resetear página
app.currentPage = 1;

// Aplicar filtros
applyFilters();

showToast('Filtros eliminados', 'success');
}

function updateActiveFilters() {
const container = document.getElementById('activeFilters');
container.innerHTML = '';

const hasFilters = Object.values(app.filters).some(value => value !== '');

if (!hasFilters) {
container.innerHTML = '<span class="text-muted">No hay filtros activos</span>';
return;
}

// Mostrar filtros activos
if (app.filters.date) {
addFilterTag('Fecha', app.filters.date, 'date');
}
if (app.filters.route) {
addFilterTag('Ruta', app.filters.route, 'route');
}
if (app.filters.truck) {
addFilterTag('Unidad', app.filters.truck, 'truck');
}
if (app.filters.driver) {
addFilterTag('Chofer', app.filters.driver, 'driver');
}
}

function addFilterTag(label, value, filterKey) {
const container = document.getElementById('activeFilters');
const tag = document.createElement('div');
tag.className = 'filter-tag';
tag.innerHTML = `
 ${label}: ${value}
<i class="fas fa-times" onclick="removeFilter('${filterKey}')" title="Eliminar filtro"></i>
`;
container.appendChild(tag);
}

function removeFilter(filterKey) {
// Limpiar el filtro específico
document.getElementById(`filter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}`).value = '';
app.filters[filterKey] = '';

// Resetear página
app.currentPage = 1;

// Aplicar filtros
applyFilters();

showToast('Filtro eliminado', 'info');
}

function updateHistoryTable() {
const tbody = document.getElementById('historyTableBody');
tbody.innerHTML = '';

if (app.filteredData.length === 0) {
tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay registros que coincidan con los filtros</td></tr>';
return;
}

// Ordenar por fecha (más reciente primero)
const sortedData = [...app.filteredData].sort((a, b) => new Date(b.date) - new Date(a.date));

// Aplicar paginación
const startIndex = (app.currentPage - 1) * app.itemsPerPage;
const endIndex = startIndex + app.itemsPerPage;
const pageData = sortedData.slice(startIndex, endIndex);

pageData.forEach(record => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${formatDate(record.date)}</td>
<td>${record.route}</td>
<td>${record.truck}</td>
<td>${formatDriverName(record.driver)}</td>
<td><span class="badge bg-success">Completada</span></td>
<td class="actions-cell">
<button class="btn btn-sm btn-outline-primary" onclick="editRouteFromDashboard(${record.id})">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRoute(${record.id})">
<i class="fas fa-trash"></i>
</button>
</td>
`;
tbody.appendChild(row);
});
}

function updateResultsInfo() {
const total = app.routeRecords.length;
const filtered = app.filteredData.length;
const showing = Math.min(filtered, app.itemsPerPage);
const start = filtered > 0 ? ((app.currentPage - 1) * app.itemsPerPage) + 1 : 0;
const end = Math.min(start + showing - 1, filtered);

document.getElementById('resultsCount').textContent = 
filtered === total ? 
`Mostrando ${filtered} de ${total} resultados` : 
`Mostrando ${start}-${end} de ${filtered} resultados (total: ${total})`;
}

function updatePagination() {
const paginationElement = document.getElementById('historyPagination');
paginationElement.innerHTML = '';

const totalPages = Math.ceil(app.filteredData.length / app.itemsPerPage);
if (totalPages <= 1) return;

// Botón Anterior
const prevLi = document.createElement('li');
prevLi.className = `page-item ${app.currentPage === 1 ? 'disabled' : ''}`;
prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${app.currentPage - 1})">Anterior</a>`;
paginationElement.appendChild(prevLi);

// Números de página
let startPage = Math.max(1, app.currentPage - 2);
let endPage = Math.min(totalPages, startPage + 4);

if (endPage - startPage < 4) {
startPage = Math.max(1, endPage - 4);
}

for (let i = startPage; i <= endPage; i++) {
const li = document.createElement('li');
li.className = `page-item ${i === app.currentPage ? 'active' : ''}`;
li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
paginationElement.appendChild(li);
}

// Botón Siguiente
const nextLi = document.createElement('li');
nextLi.className = `page-item ${app.currentPage === totalPages ? 'disabled' : ''}`;
nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${app.currentPage + 1})">Siguiente</a>`;
paginationElement.appendChild(nextLi);
}

function changePage(page) {
const totalPages = Math.ceil(app.filteredData.length / app.itemsPerPage);
if (page < 1 || page > totalPages) return;

app.currentPage = page;
updateHistoryTable();
updatePagination();

// Scroll al inicio de la tabla
document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
}

// ============================================
// FUNCIONES DE LISTAS MEJORADAS
// ============================================

function updateRoutesList() {
const container = document.getElementById('routesList');
const countBadge = document.getElementById('routesCount');
countBadge.textContent = `${app.routes.length} rutas`;

if (app.routes.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-route"></i>
<h4>No hay rutas registradas</h4>
<p>Agrega tu primera ruta usando el botón de arriba</p>
</div>
`;
return;
}

container.innerHTML = '';
app.routes.forEach((route, index) => {
const item = document.createElement('div');
item.className = 'list-item';
item.innerHTML = `
<div class="list-item-content">
<div class="list-item-title">${route}</div>
<div class="list-item-subtitle">Ruta de transporte</div>
</div>
<div class="list-item-actions">
<button class="btn btn-sm btn-outline-primary" onclick="editRoute(${index})">
<i class="fas fa-edit"></i> Editar
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRouteItem('routes', ${index})">
<i class="fas fa-trash"></i> Eliminar
</button>
</div>
`;
container.appendChild(item);
});
}

function updateDriversList() {
const container = document.getElementById('driversList');
const countBadge = document.getElementById('driversCount');
countBadge.textContent = `${app.drivers.length} choferes`;

if (app.drivers.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-user-tie"></i>
<h4>No hay choferes registrados</h4>
<p>Agrega tu primer chofer usando el botón de arriba</p>
</div>
`;
return;
}

container.innerHTML = '';
app.drivers.forEach((driver, index) => {
const item = document.createElement('div');
item.className = 'list-item';
item.innerHTML = `
<div class="list-item-content">
<div class="list-item-title">${driver}</div>
<div class="list-item-subtitle">Chofer disponible</div>
</div>
<div class="list-item-actions">
<button class="btn btn-sm btn-outline-primary" onclick="editDriver(${index})">
<i class="fas fa-edit"></i> Editar
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRouteItem('drivers', ${index})">
<i class="fas fa-trash"></i> Eliminar
</button>
</div>
`;
container.appendChild(item);
});
}

function updateTrucksList() {
const container = document.getElementById('trucksList');
const countBadge = document.getElementById('trucksCount');
countBadge.textContent = `${app.trucks.length} unidades`;

if (app.trucks.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-truck-pickup"></i>
<h4>No hay unidades registradas</h4>
<p>Agrega tu primera unidad usando el botón de arriba</p>
</div>
`;
return;
}

container.innerHTML = '';
app.trucks.forEach((truck, index) => {
const isMarked = app.markedTrucks.has(truck.number);

const item = document.createElement('div');
item.className = 'list-item';
item.innerHTML = `
<div class="list-item-content">
<div class="list-item-title">${truck.number}</div>
<div class="list-item-subtitle">${truck.model}</div>
 ${isMarked ? '<span class="badge bg-warning ms-2">Marcada para rellenar</span>' : ''}
</div>
<div class="list-item-actions">
<button class="btn btn-sm btn-outline-primary" onclick="editTruck(${index})">
<i class="fas fa-edit"></i> Editar
</button>
<button class="btn btn-sm btn-outline-warning" onclick="debugRefillState()">
<i class="fas fa-bug"></i> Depurar
</button>
<button class="btn btn-sm btn-outline-danger" onclick="deleteRouteItem('trucks', ${index})">
<i class="fas fa-trash"></i> Eliminar
</button>
</div>
`;
container.appendChild(item);
});
}

// Funciones para editar elementos
function editRoute(index) {
const route = app.routes[index];
document.getElementById('editRouteName').value = route;
document.getElementById('editRouteIndex').value = index;

const modal = new bootstrap.Modal(document.getElementById('editRouteModal'));
modal.show();
}

function editDriver(index) {
const driver = app.drivers[index];
document.getElementById('editDriverName').value = driver;
document.getElementById('editDriverIndex').value = index;

const modal = new bootstrap.Modal(document.getElementById('editDriverModal'));
modal.show();
}

function editTruck(index) {
const truck = app.trucks[index];
document.getElementById('editTruckNumber').value = truck.number;
document.getElementById('editTruckModel').value = truck.model;
document.getElementById('editTruckIndex').value = index;

const modal = new bootstrap.Modal(document.getElementById('editTruckModal'));
modal.show();
}

// Función para actualizar elementos
function updateElement(type) {
let index, newValue, newModel;

switch(type) {
case 'route':
index = parseInt(document.getElementById('editRouteIndex').value);
newValue = document.getElementById('editRouteName').value.trim();

if (!newValue) {
showToast('Por favor ingrese el nombre de la ruta', 'error');
return;
}

if (app.routes.includes(newValue) && app.routes[index] !== newValue) {
showToast('Esta ruta ya existe', 'error');
return;
}

saveState('Actualizar ruta');
app.routes[index] = newValue;
break;

case 'driver':
index = parseInt(document.getElementById('editDriverIndex').value);
newValue = document.getElementById('editDriverName').value.trim();

if (!newValue) {
showToast('Por favor ingrese el nombre del chofer', 'error');
return;
}

if (app.drivers.includes(newValue) && app.drivers[index] !== newValue) {
showToast('Este chofer ya existe', 'error');
return;
}

saveState('Actualizar chofer');
app.drivers[index] = newValue;
break;

case 'truck':
index = parseInt(document.getElementById('editTruckIndex').value);
newValue = document.getElementById('editTruckNumber').value.trim();
newModel = document.getElementById('editTruckModel').value.trim();

if (!newValue || !newModel) {
showToast('Por favor complete todos los campos', 'error');
return;
}

if (app.trucks.find(t => t.number === newValue && app.trucks[index].number !== newValue)) {
showToast('Esta unidad ya existe', 'error');
return;
}

saveState('Actualizar unidad');
app.trucks[index] = {
number: newValue,
model: newModel
};
break;
}

saveDataToFirebase(); // <-- CAMBIO CLAVE
updateUI();

// Cerrar modal
const modalId = type === 'route' ? 'editRouteModal' : type === 'driver' ? 'editDriverModal' : 'editTruckModal';
const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
modal.hide();

showToast(`${type === 'route' ? 'Ruta' : type === 'driver' ? 'Chofer' : 'Unidad'} actualizado correctamente`, 'success');
}

// Delete Item from Lists
function deleteRouteItem(type, index) {
let itemName;
switch(type) {
case 'routes':
itemName = app.routes[index];
break;
case 'drivers':
itemName = app.drivers[index];
break;
case 'trucks':
itemName = app.trucks[index].number;
break;
}

if (confirm(`¿Está seguro de que desea eliminar este ${type === 'routes' ? 'ruta' : type === 'drivers' ? 'chofer' : 'unidad'}?`)) {
saveState(`Eliminar ${type}`);

switch(type) {
case 'routes':
app.routes.splice(index, 1);
break;
case 'drivers':
app.drivers.splice(index, 1);
break;
case 'trucks':
app.trucks.splice(index, 1);
break;
}

saveDataToFirebase(); // <-- CAMBIO CLAVE
updateUI();

showToast(`${type === 'routes' ? 'Ruta' : type === 'drivers' ? 'Chofer' : 'Unidad'} eliminado correctamente`, 'success');
}
}

// Save New Element
function saveNewElement(type) {
let name, model;

switch(type) {
case 'route':
name = document.getElementById('newRouteName').value.trim();
if (!name) {
showToast('Por favor ingrese el nombre de la ruta', 'error');
return;
}

if (app.routes.includes(name)) {
showToast('Esta ruta ya existe', 'error');
return;
}

saveState('Agregar ruta');
app.routes.push(name);
break;

case 'driver':
name = document.getElementById('newDriverName').value.trim();
if (!name) {
showToast('Por favor ingrese el nombre del chofer', 'error');
return;
}

if (app.drivers.includes(name)) {
showToast('Este chofer ya existe', 'error');
return;
}

saveState('Agregar chofer');
app.drivers.push(name);
break;

case 'truck':
name = document.getElementById('newTruckNumber').value.trim();
model = document.getElementById('newTruckModel').value.trim();

if (!name || !model) {
showToast('Por favor complete todos los campos', 'error');
return;
}

if (app.trucks.find(t => t.number === name)) {
showToast('Esta unidad ya existe', 'error');
return;
}

saveState('Agregar unidad');
app.trucks.push({
number: name,
model: model
});
break;
}

saveDataToFirebase(); // <-- CAMBIO CLAVE
updateUI();

// Close modal
const modalId = type === 'route' ? 'addRouteModal' : type === 'driver' ? 'addDriverModal' : 'addTruckModal';
const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
modal.hide();

// Clear form
document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Form`).reset();

showToast(`${type === 'route' ? 'Ruta' : type === 'driver' ? 'Chofer' : 'Unidad'} agregado correctamente`, 'success');
}

// Filter List
function filterList(type, searchTerm) {
const container = document.getElementById(`${type}List`);
const items = container.getElementsByClassName('list-item');

Array.from(items).forEach(item => {
const text = item.textContent.toLowerCase();
item.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
});
}

// ============================================
// RESTO DE FUNCIONES (MODIFICADAS PARA USAR FIREBASE)
// ============================================

// Setup Event Listeners
function setupEventListeners() {
document.getElementById('prevWeekBtn').addEventListener('click', function() {
navigateWeek(-1);
});

document.getElementById('nextWeekBtn').addEventListener('click', function() {
navigateWeek(1);
});

document.getElementById('calendarPicker').addEventListener('change', function() {
navigateToDate(this.value);
});

document.getElementById('refillToggle').addEventListener('click', function() {
toggleRefillSection();
});

document.getElementById('exportBtn').addEventListener('click', function() {
exportToCSV();
});

document.getElementById('exportPDFBtn').addEventListener('click', function() {
exportToPDF();
});

document.getElementById('searchRoutes').addEventListener('input', function() {
filterList('routes', this.value);
});

document.getElementById('searchDrivers').addEventListener('input', function() {
filterList('drivers', this.value);
});

document.getElementById('searchTrucks').addEventListener('input', function() {
filterList('trucks', this.value);
});

document.getElementById('saveNewRoute').addEventListener('click', function() {
saveNewElement('route');
});

document.getElementById('saveNewDriver').addEventListener('click', function() {
saveNewElement('driver');
});

document.getElementById('saveNewTruck').addEventListener('click', function() {
saveNewElement('truck');
});

// Event listeners para botones de actualizar
document.getElementById('updateRoute').addEventListener('click', function() {
updateElement('route');
});

document.getElementById('updateDriver').addEventListener('click', function() {
updateElement('driver');
});

document.getElementById('updateTruck').addEventListener('click', function() {
updateElement('truck');
});

document.getElementById('confirmClearHistory').addEventListener('change', function() {
document.getElementById('confirmClearHistoryBtn').disabled = !this.checked;
});

document.getElementById('confirmClearHistoryBtn').addEventListener('click', function() {
clearHistory();
});

document.getElementById('confirmResetData').addEventListener('change', function() {
document.getElementById('confirmResetDataBtn').disabled = !this.checked;
});

document.getElementById('confirmResetDataBtn').addEventListener('click', function() {
resetAllData();
});
}

// Setup Undo/Redo
function setupUndoRedo() {
document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('redoBtn').addEventListener('click', redo);

document.addEventListener('keydown', function(e) {
if (e.ctrlKey || e.metaKey) {
if (e.key === 'z' && !e.shiftKey) {
e.preventDefault();
undo();
} else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
e.preventDefault();
redo();
}
}
});
}

// Save State for Undo/Redo
function saveState(action) {
const state = {
routeRecords: JSON.parse(JSON.stringify(app.routeRecords)),
trucks: JSON.parse(JSON.stringify(app.trucks)),
markedTrucks: Array.from(app.markedTrucks.entries()),
action: action,
timestamp: Date.now()
};

app.history = app.history.slice(0, app.historyIndex + 1);
app.history.push(state);
app.historyIndex++;

if (app.history.length > app.maxHistorySize) {
app.history.shift();
app.historyIndex--;
}

updateUndoRedoButtons();
}

// Undo
function undo() {
if (app.historyIndex > 0) {
app.historyIndex--;
const state = app.history[app.historyIndex];
app.routeRecords = JSON.parse(JSON.stringify(state.routeRecords));
app.trucks = JSON.parse(JSON.stringify(state.trucks));
app.markedTrucks = new Map(state.markedTrucks || []);

saveDataToFirebase(); // <-- CAMBIO CLAVE
updateUI();
updateStatistics();
updateUndoRedoButtons();

showToast(`Deshacer: ${state.action}`, 'info');
}
}

// Redo
function redo() {
if (app.historyIndex < app.history.length - 1) {
app.historyIndex++;
const state = app.history[app.historyIndex];
app.routeRecords = JSON.parse(JSON.stringify(state.routeRecords));
app.trucks = JSON.parse(JSON.stringify(state.trucks));
app.markedTrucks = new Map(state.markedTrucks || []);

saveDataToFirebase(); // <-- CAMBIO CLAVE
updateUI();
updateStatistics();
updateUndoRedoButtons();

showToast(`Rehacer: ${state.action}`, 'info');
}
}

// Update Undo/Redo Buttons
function updateUndoRedoButtons() {
document.getElementById('undoBtn').disabled = app.historyIndex <= 0;
document.getElementById('redoBtn').disabled = app.historyIndex >= app.history.length - 1;
}

// Update Connection Status
function updateConnectionStatus() {
const indicator = document.getElementById('connectionIndicator');
const isOnline = navigator.onLine;

if (isOnline) {
indicator.className = 'connection-indicator online';
indicator.innerHTML = '<i class="fas fa-wifi"></i><span>Online</span>';

if (!app.isOnline) {
// syncData(); // Ya no es necesario, los listeners lo hacen solo
}
} else {
indicator.className = 'connection-indicator offline';
indicator.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
showToast('Modo offline activado', 'warning');
}

app.isOnline = isOnline;
}

// Check Notifications
function checkNotifications() {
const needsRefillCount = app.markedTrucks.size;
const today = new Date();
today.setFullYear(2025);
const todayStr = toLocalDateString(today);
const todayRoutes = app.routeRecords.filter(r => r.date === todayStr);

let notificationCount = 0;

if (needsRefillCount > 0) {
notificationCount++;
addNotification(`${needsRefillCount} camioneta(s) necesitan rellenar`, 'warning');
}

if (todayRoutes.length === 0) {
notificationCount++;
addNotification('No hay rutas programadas para hoy', 'info');
}

if (notificationCount > 0) {
const badge = document.getElementById('notificationBadge');
badge.textContent = notificationCount;
badge.style.display = 'flex';
}
}

// Add Notification
function addNotification(message, type) {
app.notifications.push({ message, type, timestamp: Date.now() });
showToast(message, type);
}

// Toggle Refill Section
function toggleRefillSection() {
const list = document.getElementById('refillList');
const toggle = document.getElementById('refillToggle');

if (list.style.display === 'none') {
list.style.display = 'block';
toggle.classList.add('active');
toggle.innerHTML = '<i class="fas fa-times"></i> Ocultar Lista';
updateRefillList();
} else {
list.style.display = 'none';
toggle.classList.remove('active');
toggle.innerHTML = '<i class="fas fa-filter"></i> Mostrar Lista';
}
}

// Toggle Truck Refill
function toggleTruckRefill(recordId) {
const record = app.routeRecords.find(r => r.id === recordId);
if (!record) return;

const truckNumber = record.truck;
const routeName = record.route;

if (app.markedTrucks.has(truckNumber)) {
const removed = app.markedTrucks.get(truckNumber);
app.markedTrucks.delete(truckNumber);
showToast(`Camioneta ${truckNumber} desmarcada de ruta ${removed.route}`, 'success');
} else {
app.markedTrucks.set(truckNumber, {
route: routeName,
driver: record.driver,
recordId: recordId,
date: record.date
});
showToast(`Camioneta ${truckNumber} marcada para rellenar en ruta ${routeName}`, 'warning');
}

saveState('Marcar camioneta para rellenar');
saveDataToFirebase(); // <-- CAMBIO CLAVE
updateWeeklyBoard();
updateRefillList();
checkNotifications();
}

// Update Weekly Board
function updateWeeklyBoard() {
const days = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'];

days.forEach((day, index) => {
const dayRoutes = app.routeRecords.filter(record => {
return record.date === app.currentWeek[index];
});

const routesContainer = document.getElementById(`routes-${day}`);
const countBadge = document.getElementById(`count-${day}`);

countBadge.textContent = dayRoutes.length;

if (dayRoutes.length === 0) {
if (!routesContainer.querySelector('.empty-state')) {
routesContainer.innerHTML = `
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
`;
}
} else {
routesContainer.innerHTML = '';

dayRoutes.forEach(record => {
const routeRow = document.createElement('div');
routeRow.className = 'route-row';
routeRow.dataset.id = record.id;

const markedInfo = app.markedTrucks.get(record.truck);
const needsRefill = markedInfo !== undefined;
const isThisTheMarkedRecord = markedInfo && markedInfo.recordId === record.id;

let truckClass = '';
if (needsRefill) {
if (isThisTheMarkedRecord) {
truckClass = 'needs-refill selected-record';
} else {
truckClass = 'needs-refill other-record';
}
}

routeRow.innerHTML = `
<div class="route-field route" onclick="showRouteOptions(${record.id}, 'route')">${record.route}</div>
<div class="route-field driver" onclick="showRouteOptions(${record.id}, 'driver')">${formatDriverName(record.driver)}</div>
<div class="route-field truck ${truckClass}" 
title="${needsRefill ? (isThisTheMarkedRecord ? 'Marcada en esta ruta' : 'Marcada en otra ruta: ' + markedInfo.route) : ''}" 
onclick="showRouteOptions(${record.id}, 'truck')">
 ${record.truck}
 ${isThisTheMarkedRecord ? '<span class="selected-indicator">✓</span>' : ''}
</div>
<div class="route-actions">
<button class="fuel-btn" onclick="toggleTruckRefill(${record.id})" title="${needsRefill ? 'Desmarcar' : 'Marcar para rellenar'}">
<i class="fas fa-gas-pump"></i>
</button>
<button class="delete-btn" onclick="deleteRoute(${record.id})" title="Eliminar">
<i class="fas fa-trash"></i>
</button>
</div>
`;

routesContainer.appendChild(routeRow);
});
}
});

updateStatistics();
}

// Update Refill List
function updateRefillList() {
const textContent = document.getElementById('refillTextContent');
const markedTrucksInWeek = [];

app.markedTrucks.forEach((markedInfo, truckNumber) => {
if (app.currentWeek.includes(markedInfo.date)) {
markedTrucksInWeek.push({
truck: truckNumber,
route: markedInfo.route,
driver: markedInfo.driver
});
}
});

if (markedTrucksInWeek.length === 0) {
textContent.textContent = 'No hay camionetas marcadas para rellenar esta semana';
return;
}

const textLines = markedTrucksInWeek.map(item => {
const driverShortName = formatDriverName(item.driver);
return `${item.truck} ${item.route} ${driverShortName}`;
});

textContent.textContent = textLines.join('\n');
}

// Copy Refill Text
function copyRefillText() {
const textContent = document.getElementById('refillTextContent').textContent;

if (!textContent || textContent === 'No hay camionetas marcadas para rellenar esta semana') {
showToast('No hay texto para copiar', 'warning');
return;
}

const textarea = document.createElement('textarea');
textarea.value = textContent;
document.body.appendChild(textarea);

textarea.select();
textarea.setSelectionRange(0, 99999);

document.execCommand('copy');

document.body.removeChild(textarea);

showToast('Texto copiado al portapapeles', 'success');
}

// FUNCIÓN AUXILIAR PARA CONVERTIR FECHA A STRING LOCAL
function toLocalDateString(date) {
const year = date.getFullYear();
const month = String(date.getMonth() + 1).padStart(2, '0');
const day = String(date.getDate()).padStart(2, '0');
return `${year}-${month}-${day}`;
}

// Initialize Week
function initializeWeek() {
const today = new Date();
today.setFullYear(2025);
const currentDay = today.getDay();
const monday = new Date(today);
monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
monday.setFullYear(2025);

app.currentWeekStart = monday;
calculateCurrentWeek(monday);
updateWeekRange();
updateDayDates();
}

// Calculate Current Week
function calculateCurrentWeek(monday) {
app.currentWeek = [];

for (let i = 0; i < 7; i++) {
const date = new Date(monday);
date.setDate(monday.getDate() + i);
app.currentWeek.push(toLocalDateString(date));
}
}

// Update Day Dates
function updateDayDates() {
const days = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'];

days.forEach((day, index) => {
const dateElement = document.getElementById(`date-${day}`);
const dayCard = document.querySelector(`.day-card[data-day="${day}"]`);

if (dateElement) {
const dateParts = app.currentWeek[index].split('-');
const year = parseInt(dateParts[0]);
const month = parseInt(dateParts[1]) - 1;
const day = parseInt(dateParts[2]);
const date = new Date(year, month, day);

const options = { 
weekday: 'long', 
year: 'numeric', 
month: 'long', 
day: 'numeric' 
};

const formattedDate = date.toLocaleDateString('es-ES', options);
const capitalizedDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);

dateElement.textContent = capitalizedDate;
}

if (dayCard) {
dayCard.classList.remove('today');

const today = new Date();
today.setFullYear(2025);
today.setHours(0, 0, 0, 0);
const currentDate = new Date(app.currentWeek[index]);
currentDate.setHours(0, 0, 0, 0);

if (today.getTime() === currentDate.getTime()) {
dayCard.classList.add('today');
}
}
});
}

// Navigate Week
function navigateWeek(direction) {
const newStart = new Date(app.currentWeekStart);
newStart.setDate(newStart.getDate() + (direction * 7));
newStart.setFullYear(2025);

app.currentWeekStart = newStart;
calculateCurrentWeek(newStart);
updateWeekRange();
updateDayDates();
updateWeeklyBoard();

showToast(`Semana ${direction > 0 ? 'siguiente' : 'anterior'}`, 'info');
}

// Navigate to specific date
function navigateToDate(dateString) {
if (!dateString) return;

const dateParts = dateString.split('-');
const year = parseInt(dateParts[0]);
const month = parseInt(dateParts[1]) - 1;
const day = parseInt(dateParts[2]);

const selectedDate = new Date(year, month, day);
selectedDate.setFullYear(2025);
const currentDay = selectedDate.getDay();

const monday = new Date(selectedDate);
const dayOffset = currentDay === 0 ? -6 : 1 - currentDay;
monday.setDate(selectedDate.getDate() + dayOffset);
monday.setFullYear(2025);
monday.setHours(12, 0, 0, 0);

app.currentWeekStart = monday;
calculateCurrentWeek(monday);
updateWeekRange();
updateDayDates();
updateWeeklyBoard();

const dashboardTab = document.getElementById('dashboard-tab');
if (!dashboardTab.classList.contains('active')) {
const tab = new bootstrap.Tab(dashboardTab);
tab.show();
}

showToast(`Navegando a la semana del ${dateString}`, 'info');
}

// Update Week Range Display
function updateWeekRange() {
const startDate = app.currentWeekStart;
const endDate = new Date(startDate);
endDate.setDate(startDate.getDate() + 6);

const options = { day: 'numeric', month: 'short', year: 'numeric' };
const startStr = startDate.toLocaleDateString('es-ES', options);
const endStr = endDate.toLocaleDateString('es-ES', options);
document.getElementById('weekRange').textContent = `Semana del ${startStr} al ${endStr}`;
}

// Clear History
function clearHistory() {
saveState('Limpiar historial');
app.routeRecords = [];
app.filteredData = [];
saveDataToFirebase(); // <-- CAMBIO CLAVE
updateUI();
updateStatistics();

const modal = bootstrap.Modal.getInstance(document.getElementById('clearHistoryModal'));
modal.hide();

document.getElementById('confirmClearHistory').checked = false;
document.getElementById('confirmClearHistoryBtn').disabled = true;

showToast('Historial eliminado correctamente', 'success');
}

// Reset All Data
function resetAllData() {
app.routes = [
'MELI', 'REFA MAÑANA', 'MARTINEZ', 'POZA RICA', 'PAPANTLA', 
'REFA TARDE', 'MISANTLA', 'PACHUCA', 'IXMIQUILPAN', 
'OAXACA CENTRO', 'OAXACA COSTA', 'CIUDAD VALLES', 
'TULANCINGO', 'VERACRUZ', 'ACAPULCO', 'RUTA CHICA',
'CAMIONETA OAXACA COSTA', 'CAMIONETA CIUDAD VALLES', 
'CAMIONETA MISANTLA', 'RUMPAQ CAPECHE', 'CAMIONETA PACHUCA', 
'CAMIONETA TEZIUTLAN'
];

app.drivers = [
'Alfredo García', 'Emilio López', 'Guevara Martínez', 'Nahim Hernández', 'Juan Pérez', 'Rafael Rodríguez', 
'Efrén Díaz', 'Tomás Sánchez', 'Guillermo Torres', 'Julio Ramírez', 'Bedolla Morales', 
'Fabian Castro', 'Javier Vargas', 'Posadas Silva', 'Alan Ruiz', 'Omar Mendoza', 
'César Jiménez', 'Jorge Aguilar', 'Marcelo Ortiz', 'William Clark'
];

app.trucks = [
{ number: '56', model: 'SILVERADO 3500' },
{ number: '76', model: 'CRAFTER' },
{ number: '79', model: 'TORNADO' },
{ number: '82', model: 'CRAFTER' },
{ number: '98', model: 'SAVEIRO' },
{ number: '108', model: 'SAVEIRO' },
{ number: '110', model: 'CRAFTER' },
{ number: '120', model: 'SAVEIRO' },
{ number: '126', model: 'SAVEIRO' },
{ number: '137', model: 'CRAFTER' },
{ number: '138', model: 'KANGOO' },
{ number: '149', model: 'SAVEIRO' },
{ number: '150', model: 'SAVEIRO' },
{ number: '158', model: 'KANGOO' },
{ number: '166', model: 'HIACE' },
{ number: '170', model: 'SILVERADO' },
{ number: '179', model: 'TORNADO' },
{ number: '121', model: 'SAVEIRO' }
];

app.routeRecords = [];
app.filteredData = [];
app.markedTrucks = new Map();

saveDataToFirebase(); // <-- CAMBIO CLAVE

const modal = bootstrap.Modal.getInstance(document.getElementById('resetDataModal'));
modal.hide();

document.getElementById('confirmResetData').checked = false;
document.getElementById('confirmResetDataBtn').disabled = true;

updateUI();
updateStatistics();

showToast('Aplicación restablecida correctamente', 'success');
}

// Update UI
function updateUI() {
updateWeeklyBoard();
updateRoutesList();
updateDriversList();
updateTrucksList();
updateHistory();
updateFilterOptions();

if (document.getElementById('refillList').style.display !== 'none') {
updateRefillList();
}

// Actualizar calendario si está visible
if (document.getElementById('calendar-tab').classList.contains('active')) {
renderCalendar();
}
}

// Update Statistics
function updateStatistics() {
document.getElementById('totalRoutes').textContent = app.routeRecords.length;

const today = new Date();
today.setFullYear(2025);
const todayStr = toLocalDateString(today);
const todayTrucks = app.routeRecords.filter(r => r.date === todayStr);
document.getElementById('activeTrucks').textContent = todayTrucks.length;

document.getElementById('totalDrivers').textContent = app.drivers.length;

const weekRoutes = app.routeRecords.filter(r => app.currentWeek.includes(r.date));
document.getElementById('weekRoutes').textContent = weekRoutes.length;
}

// Add New Route Row
function addNewRouteRow(day) {
const dayIndex = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'].indexOf(day);
const date = app.currentWeek[dayIndex];
const routesContainer = document.getElementById(`routes-${day}`);

const noRoutesMessage = routesContainer.querySelector('.empty-state');
if (noRoutesMessage) {
noRoutesMessage.remove();
}

const formDiv = document.createElement('div');
formDiv.className = 'inline-route-form';
formDiv.innerHTML = `
<select class="form-select" id="route-select-${day}">
<option value="">Ruta</option>
 ${app.routes.map(route => `<option value="${route}">${route}</option>`).join('')}
</select>
<select class="form-select" id="truck-select-${day}">
<option value="">Unidad</option>
 ${app.trucks.map(truck => `<option value="${truck.number}">${truck.number}</option>`).join('')}
</select>
<select class="form-select" id="driver-select-${day}">
<option value="">Chofer</option>
 ${app.drivers.map(driver => `<option value="${driver}">${formatDriverName(driver)}</option>`).join('')}
</select>
<button class="btn btn-success btn-sm" onclick="saveInlineRoute('${day}')">
<i class="fas fa-check"></i>
</button>
<button class="btn btn-danger btn-sm" onclick="cancelInlineRoute('${day}')">
<i class="fas fa-times"></i>
</button>
`;

routesContainer.appendChild(formDiv);

document.getElementById(`route-select-${day}`).focus();
}

// Save Inline Route
function saveInlineRoute(day) {
const dayIndex = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'].indexOf(day);
const date = app.currentWeek[dayIndex];

const route = document.getElementById(`route-select-${day}`).value;
const truck = document.getElementById(`truck-select-${day}`).value;
const driver = document.getElementById(`driver-select-${day}`).value;

if (!route || !truck || !driver) {
showToast('Por favor complete todos los campos', 'error');
return;
}

const fullDriverName = app.drivers.find(d => formatDriverName(d) === driver);

const newRecord = {
id: Date.now(),
date,
route,
truck,
driver: fullDriverName
};

saveState('Agregar ruta');
app.routeRecords.push(newRecord);
saveDataToFirebase(); // <-- CAMBIO CLAVE

updateMultipleUIElements(['weeklyBoard', 'history', 'statistics']);
checkNotifications();

showToast(`Ruta agregada correctamente para ${day}`, 'success');
}

// Cancel Inline Route
function cancelInlineRoute(day) {
const routesContainer = document.getElementById(`routes-${day}`);
const form = routesContainer.querySelector('.inline-route-form');
if (form) {
form.remove();
}

if (routesContainer.children.length === 0) {
routesContainer.innerHTML = `
<div class="empty-state">
<i class="fas fa-route"></i>
<p>No hay rutas programadas</p>
</div>
`;
}
}

// Update Multiple UI Elements
function updateMultipleUIElements(elementsToUpdate) {
elementsToUpdate.forEach(element => {
switch(element) {
case 'weeklyBoard':
updateWeeklyBoard();
break;
case 'history':
updateHistory();
break;
case 'statistics':
updateStatistics();
break;
case 'refillList':
if (document.getElementById('refillList').style.display !== 'none') {
updateRefillList();
}
break;
}
});
}

// Show Route Options (Dropdown)
function showRouteOptions(routeId, fieldType) {
const record = app.routeRecords.find(r => r.id === routeId);
if (!record) return;

let options, currentValue;

switch(fieldType) {
case 'route':
options = app.routes;
currentValue = record.route;
break;
case 'driver':
options = app.drivers;
currentValue = record.driver;
break;
case 'truck':
options = app.trucks.map(t => t.number);
currentValue = record.truck;
break;
}

const existingDropdown = document.querySelector('.route-dropdown');
if (existingDropdown) {
existingDropdown.remove();
}

const dropdown = document.createElement('div');
dropdown.className = 'route-dropdown';
dropdown.style.position = 'absolute';
dropdown.style.backgroundColor = 'white';
dropdown.style.border = '1px solid #ddd';
dropdown.style.borderRadius = '8px';
dropdown.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
dropdown.style.zIndex = '1000';
dropdown.style.maxHeight = '200px';
dropdown.style.overflowY = 'auto';

options.forEach(option => {
const optionElement = document.createElement('div');
optionElement.style.padding = '8px 12px';
optionElement.style.cursor = 'pointer';
optionElement.style.borderBottom = '1px solid #eee';

if (fieldType === 'driver') {
optionElement.textContent = formatDriverName(option);
} else {
optionElement.textContent = option;
}

if (option === currentValue) {
optionElement.style.backgroundColor = '#007bff';
optionElement.style.color = 'white';
}

optionElement.addEventListener('mouseenter', function() {
if (option !== currentValue) {
this.style.backgroundColor = '#f0f0f0';
}
});

optionElement.addEventListener('mouseleave', function() {
if (option !== currentValue) {
this.style.backgroundColor = 'white';
}
});

optionElement.addEventListener('click', function() {
updateRouteField(routeId, fieldType, option);
dropdown.remove();
});

dropdown.appendChild(optionElement);
});

const event = window.event;
const rect = event.target.getBoundingClientRect();

dropdown.style.left = `${rect.left}px`;
dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
dropdown.style.width = `${rect.width}px`;

document.body.appendChild(dropdown);

setTimeout(() => {
document.addEventListener('click', function closeDropdown(e) {
if (!dropdown.contains(e.target)) {
dropdown.remove();
document.removeEventListener('click', closeDropdown);
}
});
}, 100);
}

// Update Route Field
function updateRouteField(routeId, fieldType, newValue) {
const record = app.routeRecords.find(r => r.id === routeId);
if (!record) return;

saveState(`Actualizar ${fieldType}`);

switch(fieldType) {
case 'route':
record.route = newValue;
break;
case 'driver':
record.driver = newValue;
break;
case 'truck':
record.truck = newValue;
break;
}

saveDataToFirebase(); // <-- CAMBIO CLAVE
updateMultipleUIElements(['weeklyBoard', 'history', 'statistics']);

showToast('Campo actualizado correctamente', 'success');
}

// Delete Route
function deleteRoute(routeId) {
if (confirm('¿Está seguro de que desea eliminar esta ruta?')) {
saveState('Eliminar ruta');
app.routeRecords = app.routeRecords.filter(r => r.id !== routeId);
saveDataToFirebase(); // <-- CAMBIO CLAVE

updateMultipleUIElements(['weeklyBoard', 'history', 'statistics']);
checkNotifications();

showToast('Ruta eliminada correctamente', 'success');
}
}

// Update History
function updateHistory() {
// Inicializar datos filtrados
app.filteredData = [...app.routeRecords];

// Aplicar filtros actuales
applyFilters();
}

// Edit Route from Dashboard
function editRouteFromDashboard(routeId) {
const record = app.routeRecords.find(r => r.id === routeId);
if (!record) return;

// Find the day of the week for this record
const recordDate = new Date(record.date);
const dayIndex = recordDate.getDay();
const dayNames = ['DOMINGO', 'LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO'];
const dayName = dayNames[dayIndex];

// Navigate to the week containing this date
navigateToDate(record.date);

// Switch to dashboard tab
const dashboardTab = document.getElementById('dashboard-tab');
const tab = new bootstrap.Tab(dashboardTab);
tab.show();

// Highlight the route
setTimeout(() => {
const routeRow = document.querySelector(`.route-row[data-id="${routeId}"]`);
if (routeRow) {
routeRow.classList.add('selected');
routeRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

setTimeout(() => {
routeRow.classList.remove('selected');
}, 2000);
}
}, 500);
}

// Export to CSV
function exportToCSV() {
let csv = 'Fecha,Ruta,Unidad,Chofer,Estado\n';

app.filteredData.forEach(record => {
csv += `${record.date},${record.route},${record.truck},${record.driver},Completada\n`;
});

const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
const url = URL.createObjectURL(blob);

link.setAttribute('href', url);
link.setAttribute('download', `rutas_${new Date().toISOString().split('T')[0]}.csv`);
link.style.visibility = 'hidden';

document.body.appendChild(link);
link.click();
document.body.removeChild(link);

showToast('Archivo CSV exportado correctamente', 'success');
}

// Export to PDF
function exportToPDF() {
const { jsPDF } = window.jspdf;
const doc = new jsPDF();

// Add title
doc.setFontSize(18);
doc.text('Historial de Rutas', 14, 22);

// Add date
doc.setFontSize(12);
doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 14, 32);

// Add table headers
doc.setFontSize(10);
doc.text('Fecha', 14, 45);
doc.text('Ruta', 50, 45);
doc.text('Unidad', 100, 45);
doc.text('Chofer', 140, 45);
doc.text('Estado', 180, 45);

// Add table data
let yPosition = 55;
app.filteredData.forEach(record => {
if (yPosition > 270) {
doc.addPage();
yPosition = 20;
}

doc.text(record.date, 14, yPosition);
doc.text(record.route, 50, yPosition);
doc.text(record.truck, 100, yPosition);
doc.text(formatDriverName(record.driver), 140, yPosition);
doc.text('Completada', 180, yPosition);

yPosition += 10;
});

doc.save(`rutas_${new Date().toISOString().split('T')[0]}.pdf`);

showToast('Archivo PDF exportado correctamente', 'success');
}

// Generate Reports
function generateReports() {
const startDate = document.getElementById('reportStartDate').value;
const endDate = document.getElementById('reportEndDate').value;

let filteredRecords = [...app.routeRecords];

if (startDate) {
filteredRecords = filteredRecords.filter(record => record.date >= startDate);
}

if (endDate) {
filteredRecords = filteredRecords.filter(record => record.date <= endDate);
}

// Generate Routes Chart
const routesCtx = document.getElementById('routesChart').getContext('2d');

if (app.charts.routes) {
app.charts.routes.destroy();
}

const routeCounts = {};
filteredRecords.forEach(record => {
routeCounts[record.route] = (routeCounts[record.route] || 0) + 1;
});

app.charts.routes = new Chart(routesCtx, {
type: 'pie',
data: {
labels: Object.keys(routeCounts),
datasets: [{
data: Object.values(routeCounts),
backgroundColor: [
'#FF6B35', '#001F3F', '#28a745', '#ffc107', '#dc3545',
'#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997'
]
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'bottom'
}
}
}
});

// Generate Trucks Chart
const trucksCtx = document.getElementById('trucksChart').getContext('2d');

if (app.charts.trucks) {
app.charts.trucks.destroy();
}

const truckCounts = {};
filteredRecords.forEach(record => {
truckCounts[record.truck] = (truckCounts[record.truck] || 0) + 1;
});

app.charts.trucks = new Chart(trucksCtx, {
type: 'bar',
data: {
labels: Object.keys(truckCounts),
datasets: [{
label: 'Uso de Unidades',
data: Object.values(truckCounts),
backgroundColor: '#001F3F'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
ticks: {
stepSize: 1
}
}
}
}
});

showToast('Reportes generados correctamente', 'success');
}

// Format Date
function formatDate(dateString) {
const dateParts = dateString.split('-');
const year = parseInt(dateParts[0]);
const month = parseInt(dateParts[1]) - 1;
const day = parseInt(dateParts[2]);
const date = new Date(year, month, day);

const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
return date.toLocaleDateString('es-ES', options);
}

// Show Toast
function showToast(message, type = 'info') {
const toastContainer = document.getElementById('toastContainer');

const toast = document.createElement('div');
toast.className = 'toast-custom';

let icon = 'fa-info-circle';
if (type === 'success') icon = 'fa-check-circle';
if (type === 'error') icon = 'fa-exclamation-circle';
if (type === 'warning') icon = 'fa-exclamation-triangle';

toast.innerHTML = `
<i class="fas ${icon}"></i>
<span>${message}</span>
`;

toastContainer.appendChild(toast);

setTimeout(() => {
toast.style.animation = 'slideIn 0.3s ease reverse';
setTimeout(() => {
toast.remove();
}, 300);
}, 3000);
}

// Add Sample Data
function addSampleData() {
const today = new Date();
today.setFullYear(2025);
const todayStr = toLocalDateString(today);

const currentDay = today.getDay();
const monday = new Date(today);
monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
monday.setFullYear(2025);

const lastWeek = new Date(monday);
lastWeek.setDate(monday.getDate() - 7);
lastWeek.setFullYear(2025);

const sampleData = [
// Datos actuales de esta semana
{ id: Date.now() + 1, date: toLocalDateString(monday), route: 'MELI', truck: '137', driver: 'Alfredo García' },
{ id: Date.now() + 2, date: toLocalDateString(monday), route: 'POZA RICA', truck: '76', driver: 'Guillermo Torres' },
{ id: Date.now() + 3, date: toLocalDateString(new Date(monday.setDate(monday.getDate() + 1))), route: 'PAPANTLA', truck: '158', driver: 'Tomás Sánchez' },
{ id: Date.now() + 4, date: toLocalDateString(new Date(monday.setDate(monday.getDate() + 1))), route: 'MISANTLA', truck: '149', driver: 'Bedolla Morales' },
{ id: Date.now() + 5, date: todayStr, route: 'PACHUCA', truck: '138', driver: 'Alfredo García' },
{ id: Date.now() + 6, date: todayStr, route: 'VERACRUZ', truck: '120', driver: 'Javier Vargas' },
{ id: Date.now() + 7, date: todayStr, route: 'CAMIONETA OAXACA COSTA', truck: '166', driver: 'Emilio López' },
{ id: Date.now() + 8, date: todayStr, route: 'CAMIONETA CIUDAD VALLES', truck: '82', driver: 'Guevara Martínez' },

// Datos de la semana pasada
{ id: Date.now() + 9, date: toLocalDateString(lastWeek), route: 'MELI', truck: '137', driver: 'Guevara Martínez' },
{ id: Date.now() + 10, date: toLocalDateString(lastWeek), route: 'REFA MAÑANA', truck: '98', driver: 'Nahim Hernández' },
{ id: Date.now() + 11, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'MARTINEZ', truck: '108', driver: 'Emilio López' },
{ id: Date.now() + 12, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'POZA RICA', truck: '82', driver: 'Guillermo Torres' },
{ id: Date.now() + 13, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'PAPANTLA', truck: '158', driver: 'Tomás Sánchez' },
{ id: Date.now() + 14, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'REFA TARDE', truck: '166', driver: 'Efrén Díaz' },
{ id: Date.now() + 15, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'CAMIONETA MISANTLA', truck: '149', driver: 'Emilio López' },
{ id: Date.now() + 16, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'CAMIONETA PACHUCA', truck: '158', driver: 'Tomás Sánchez' },
{ id: Date.now() + 17, date: toLocalDateString(new Date(lastWeek.setDate(lastWeek.getDate() + 1))), route: 'RUMPAQ CAPECHE', truck: '137', driver: 'Alfredo García' }
];

app.routeRecords = sampleData;
saveDataToFirebase(); // <-- CAMBIO CLAVE
}

// Función de depuración
function debugRefillState() {
console.log(`\n🔍 DEPURACIÓN COMPLETA DEL ESTADO`);
console.log(`====================================`);
console.log(`Tipo de app.markedTrucks:`, typeof app.markedTrucks);
console.log(`Es un Map?:`, app.markedTrucks instanceof Map);
console.log(`Contenido del Map:`, Array.from(app.markedTrucks.entries()));
console.log(`Tamaño del Map:`, app.markedTrucks.size);

console.log(`\n📋 ANÁLISIS POR CAMIONETA:`);
app.trucks.forEach(truck => {
const markedInfo = app.markedTrucks.get(truck.number);
if (markedInfo) {
console.log(`🚚 ${truck.number}: ✅ MARCADA`);
console.log(` → Ruta: ${markedInfo.route}`);
console.log(` → Chofer: ${markedInfo.driver}`);
console.log(` → Record ID: ${markedInfo.recordId}`);
console.log(` → Fecha: ${markedInfo.date}`);
} else {
console.log(`🚚 ${truck.number}: ❌ NO MARCADA`);
}
});

console.log(`====================================\n`);
}

// Función para limpiar todo
function clearAllMarks() {
if (confirm('¿Está seguro de que desea limpiar todas las marcas de rellenado?')) {
app.markedTrucks.clear();
saveState('Limpiar todas las marcas de rellenado');
saveDataToFirebase(); // <-- CAMBIO CLAVE
updateWeeklyBoard();
updateRefillList();
checkNotifications();

showToast('Todas las marcas limpiadas', 'success');
console.log('✅ Todas las marcas han sido limpiadas');
debugRefillState();
}
}
</script>

<script>
// === Sincronizar selector con el calendario principal ===
document.getElementById("calendarDate").addEventListener("change", function() {
  const selectedDate = new Date(this.value);
  if (!isNaN(selectedDate)) {
    // Asegurarnos de que la fecha esté en 2025
    selectedDate.setFullYear(2025);
    
    // Guardar la fecha seleccionada
    app.selectedDate = toLocalDateString(selectedDate);
    
    // Navegar según la vista actual
    switch(app.calendarView) {
      case 'month':
        // Navegar al mes seleccionado
        app.currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        renderCalendar();
        showToast(`Navegando a ${selectedDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`, 'info');
        break;
        
      case 'week':
        // Calcular el lunes de la semana seleccionada
        const dayOfWeek = selectedDate.getDay();
        const monday = new Date(selectedDate);
        const dayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        monday.setDate(selectedDate.getDate() + dayOffset);
        app.currentWeekStart = monday;
        renderCalendar();
        showToast(`Navegando a la semana del ${monday.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}`, 'info');
        break;
        
      case 'day':
        // Navegar al día específico
        app.currentDay = selectedDate;
        renderCalendar();
        showToast(`Navegando a ${selectedDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`, 'info');
        break;
        
      case 'list':
      case 'compact':
        // Para estas vistas, también navegamos al mes
        app.currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        renderCalendar();
        showToast(`Navegando a ${selectedDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`, 'info');
        break;
    }
    
    // Resaltar el día seleccionado si es necesario
    setTimeout(() => {
      const dayElements = document.querySelectorAll('.calendar-day');
      dayElements.forEach(dayEl => {
        dayEl.classList.remove('selected-highlight');
        const dayNumber = dayEl.querySelector('.calendar-day-number span');
        if (dayNumber && parseInt(dayNumber.textContent) === selectedDate.getDate()) {
          const dayDate = new Date(app.currentMonth.getFullYear(), app.currentMonth.getMonth(), parseInt(dayNumber.textContent));
          if (dayDate.toDateString() === selectedDate.toDateString()) {
            dayEl.classList.add('selected-highlight');
            // Hacer scroll al día si está fuera de vista
            dayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
    }, 100);
  }
});
</script>
</body>

</html>